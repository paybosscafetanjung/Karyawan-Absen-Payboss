<!doctype html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payboss HRIS System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .hidden-section { display: none !important; }
        .active-section { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }
        
        .glass-effect { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
        
        /* Camera */
        video { transform: scaleX(-1); width: 100%; height: 100%; object-fit: cover; border-radius: 1rem; }
        canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; transform: scaleX(-1); }
    </style>
</head>
<body>

    <!-- 1. LOGIN VIEW -->
    <div id="viewLogin" class="active-section min-h-screen flex items-center justify-center bg-gray-900 p-4">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md border-t-4 border-blue-600">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-extrabold text-gray-800">PAYBOSS</h1>
                <p class="text-sm text-gray-500 font-semibold tracking-wide">HRIS SYSTEM</p>
            </div>
            <form onsubmit="handleLogin(event)" class="space-y-5">
                <div>
                    <label class="text-xs font-bold text-gray-500 uppercase">ID Karyawan</label>
                    <input type="text" id="loginId" class="w-full mt-1 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Contoh: PB251101" required>
                </div>
                <div>
                    <label class="text-xs font-bold text-gray-500 uppercase">Password</label>
                    <input type="password" id="loginPass" class="w-full mt-1 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="••••••" required>
                </div>
                <button type="submit" id="btnLogin" class="w-full bg-blue-700 hover:bg-blue-800 text-white font-bold py-3 rounded-lg transition shadow-lg">
                    MASUK APLIKASI
                </button>
            </form>
        </div>
    </div>

    <!-- 2. EMPLOYEE VIEW -->
    <div id="viewEmployee" class="hidden-section min-h-screen pb-20">
        <!-- Emp Header -->
        <div class="bg-blue-800 text-white p-4 sticky top-0 z-50 shadow-lg rounded-b-3xl">
            <div class="flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <img id="empPhoto" src="" class="w-12 h-12 rounded-full border-2 border-white bg-gray-300 object-cover">
                    <div>
                        <h2 class="font-bold text-lg leading-tight" id="empNameDisplay">Nama</h2>
                        <p class="text-xs text-blue-200 font-medium bg-blue-900 px-2 py-0.5 rounded-full inline-block" id="empPosDisplay">Posisi</p>
                    </div>
                </div>
                <button onclick="logout()" class="bg-red-500/20 hover:bg-red-500 text-white p-2 rounded-lg transition">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </div>

        <!-- Emp Tabs -->
        <div class="px-4 mt-4">
            <div class="flex bg-white p-1.5 rounded-xl shadow-sm border border-gray-200">
                <button onclick="switchEmpTab('absen')" id="tabEmpAbsen" class="flex-1 py-2 text-sm font-bold rounded-lg bg-blue-100 text-blue-800">Absensi</button>
                <button onclick="switchEmpTab('tugas')" id="tabEmpTugas" class="flex-1 py-2 text-sm font-bold rounded-lg text-gray-500">Tugas & Jadwal</button>
            </div>
        </div>

        <!-- Emp Content: Absen -->
        <div id="contentEmpAbsen" class="p-4 space-y-4">
            <!-- Info Panel -->
            <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 grid grid-cols-2 gap-4">
                <div>
                    <p class="text-xs text-gray-400 font-bold uppercase">Lokasi</p>
                    <p id="gpsStatus" class="text-sm font-bold text-yellow-600 mt-0.5">Mencari...</p>
                </div>
                <div class="text-right">
                    <p class="text-xs text-gray-400 font-bold uppercase">Jam Server</p>
                    <p id="serverTime" class="text-sm font-mono font-bold text-gray-800 mt-0.5">--:--</p>
                </div>
            </div>

            <!-- Mode -->
            <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="setMode('IN')" id="btnIn" class="py-3 border-2 rounded-xl font-bold text-sm border-blue-600 bg-blue-600 text-white">MASUK</button>
                    <button onclick="setMode('OUT')" id="btnOut" class="py-3 border-2 rounded-xl font-bold text-sm border-gray-200 text-gray-500">PULANG</button>
                </div>
                <div id="reasonContainer" class="hidden mt-3">
                    <select id="attendanceReason" class="w-full p-2.5 text-sm border border-red-300 bg-red-50 rounded-lg text-red-800 font-medium outline-none focus:ring-2 focus:ring-red-500">
                        <option value="">-- Pilih Alasan (Wajib) --</option>
                        <option value="Dinas Luar">Dinas Luar</option>
                        <option value="Sakit">Sakit</option>
                        <option value="Izin">Izin</option>
                        <option value="GPS Error">Masalah GPS</option>
                    </select>
                </div>
            </div>

            <!-- Camera -->
            <div class="relative bg-black rounded-xl aspect-[3/4] overflow-hidden shadow-md border-4 border-white" id="cameraFrame">
                <video id="video" autoplay muted playsinline></video>
                <canvas id="overlay"></canvas>
                <div class="absolute bottom-4 left-0 right-0 text-center">
                    <span id="instructionBox" class="bg-black/50 text-white px-3 py-1 rounded-full text-xs font-bold backdrop-blur-sm">Memuat Kamera...</span>
                </div>
            </div>

            <!-- Submit -->
            <button id="btnSubmit" onclick="submitAttendance()" disabled class="w-full py-4 bg-gray-300 text-gray-500 font-bold rounded-xl shadow-lg transition-all">
                LENGKAPI DATA
            </button>
        </div>

        <!-- Emp Content: Tugas -->
        <div id="contentEmpTugas" class="hidden-section p-4 space-y-6">
            <!-- Roster Card -->
            <div class="bg-gradient-to-br from-blue-700 to-blue-900 rounded-2xl p-5 text-white shadow-lg relative overflow-hidden">
                <div class="absolute top-0 right-0 opacity-10 text-6xl -mr-4 -mt-4"><i class="fas fa-calendar-alt"></i></div>
                <h3 class="font-bold text-lg mb-4">Jadwal Saya (7 Hari)</h3>
                <div id="empRosterList" class="space-y-3 text-sm">Loading...</div>
            </div>

            <!-- Checklist -->
            <div>
                <h3 class="font-bold text-gray-800 text-lg mb-3 flex items-center gap-2"><i class="fas fa-tasks text-blue-600"></i> Job Desk Harian</h3>
                <div id="empTaskList" class="space-y-2">Loading...</div>
                <button onclick="submitChecklist()" class="w-full mt-6 bg-green-600 text-white font-bold py-3 rounded-xl shadow-lg hover:bg-green-700 transition">
                    KIRIM LAPORAN KERJA
                </button>
            </div>
        </div>
    </div>

    <!-- 3. MANAGER VIEW -->
    <div id="viewManager" class="hidden-section min-h-screen flex bg-gray-100">
        
        <!-- Sidebar -->
        <aside class="w-64 bg-white shadow-xl hidden md:flex flex-col fixed h-full z-20">
            <div class="p-6 border-b">
                <h1 class="text-2xl font-bold text-blue-800">PAYBOSS</h1>
                <p class="text-xs text-gray-400 font-medium tracking-wider">MANAGER DASHBOARD</p>
            </div>
            <nav class="flex-1 p-4 space-y-2 overflow-y-auto">
                <button onclick="switchMgrTab('dash')" class="mgr-nav w-full text-left px-4 py-3 rounded-lg font-medium text-gray-600 hover:bg-blue-50 hover:text-blue-700 transition flex items-center gap-3 bg-blue-50 text-blue-700">
                    <i class="fas fa-chart-pie w-5"></i> Dashboard
                </button>
                <button onclick="switchMgrTab('absensi')" class="mgr-nav w-full text-left px-4 py-3 rounded-lg font-medium text-gray-600 hover:bg-blue-50 hover:text-blue-700 transition flex items-center gap-3">
                    <i class="fas fa-history w-5"></i> Riwayat Absensi
                </button>
                <button onclick="switchMgrTab('roster')" class="mgr-nav w-full text-left px-4 py-3 rounded-lg font-medium text-gray-600 hover:bg-blue-50 hover:text-blue-700 transition flex items-center gap-3">
                    <i class="fas fa-calendar-week w-5"></i> Kelola Roster
                </button>
                <button onclick="switchMgrTab('rekap')" class="mgr-nav w-full text-left px-4 py-3 rounded-lg font-medium text-gray-600 hover:bg-blue-50 hover:text-blue-700 transition flex items-center gap-3">
                    <i class="fas fa-clock w-5"></i> Rekap Jam Kerja
                </button>
                <button onclick="switchMgrTab('progres')" class="mgr-nav w-full text-left px-4 py-3 rounded-lg font-medium text-gray-600 hover:bg-blue-50 hover:text-blue-700 transition flex items-center gap-3">
                    <i class="fas fa-check-square w-5"></i> Progres Tugas
                </button>
                <button onclick="switchMgrTab('jobdesk')" class="mgr-nav w-full text-left px-4 py-3 rounded-lg font-medium text-gray-600 hover:bg-blue-50 hover:text-blue-700 transition flex items-center gap-3">
                    <i class="fas fa-clipboard-list w-5"></i> Edit Job Desk
                </button>
                <button onclick="switchMgrTab('karyawan')" class="mgr-nav w-full text-left px-4 py-3 rounded-lg font-medium text-gray-600 hover:bg-blue-50 hover:text-blue-700 transition flex items-center gap-3">
                    <i class="fas fa-users-cog w-5"></i> Data Karyawan
                </button>
            </nav>
            <div class="p-4 border-t">
                <button onclick="logout()" class="w-full bg-red-100 text-red-600 font-bold py-2 rounded-lg hover:bg-red-200 transition">
                    <i class="fas fa-sign-out-alt mr-2"></i> Keluar
                </button>
            </div>
        </aside>

        <!-- Main Content Manager -->
        <main class="flex-1 ml-0 md:ml-64 p-6 overflow-y-auto h-screen">
            <!-- Mobile Header -->
            <div class="md:hidden flex justify-between items-center mb-6 bg-white p-4 rounded-xl shadow-sm">
                <h1 class="font-bold text-lg text-blue-800">PAYBOSS HRIS</h1>
                <button onclick="logout()" class="text-red-500"><i class="fas fa-sign-out-alt"></i></button>
            </div>
            
            <!-- 1. DASHBOARD HOME -->
            <div id="mgrPage-dash" class="mgr-page space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-blue-500">
                        <p class="text-xs font-bold text-gray-400 uppercase">Total Karyawan</p>
                        <p class="text-3xl font-bold text-gray-800 mt-2" id="statTotalEmp">0</p>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-green-500">
                        <p class="text-xs font-bold text-gray-400 uppercase">Hadir Hari Ini</p>
                        <p class="text-3xl font-bold text-gray-800 mt-2" id="statHadir">0</p>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-red-500">
                        <p class="text-xs font-bold text-gray-400 uppercase">Terlambat</p>
                        <p class="text-3xl font-bold text-gray-800 mt-2" id="statTelat">0</p>
                    </div>
                </div>
                <!-- Grafik Absensi Mingguan -->
                <div class="bg-white p-6 rounded-xl shadow-sm">
                    <h3 class="font-bold text-gray-700 mb-4">Tren Kehadiran Minggu Ini</h3>
                    <canvas id="attendanceChart" height="100"></canvas>
                </div>
            </div>

            <!-- 2. RIWAYAT ABSENSI -->
            <div id="mgrPage-absensi" class="mgr-page hidden-section bg-white p-6 rounded-xl shadow-sm">
                <h2 class="font-bold text-xl text-gray-800 mb-4">Riwayat Absensi Lengkap</h2>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left border-collapse">
                        <thead class="bg-gray-50 text-gray-500">
                            <tr>
                                <th class="p-3">Waktu</th>
                                <th class="p-3">Nama</th>
                                <th class="p-3">Posisi</th>
                                <th class="p-3">Status</th>
                                <th class="p-3">Detail</th>
                                <th class="p-3">Bukti</th>
                            </tr>
                        </thead>
                        <tbody id="tableHistory" class="divide-y divide-gray-100"></tbody>
                    </table>
                </div>
            </div>

            <!-- 3. KELOLA ROSTER -->
            <div id="mgrPage-roster" class="mgr-page hidden-section bg-white p-6 rounded-xl shadow-sm">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="font-bold text-xl text-gray-800">Kelola Roster Bulanan</h2>
                    <div class="flex gap-2">
                         <input type="month" id="rosterMonthPicker" class="border p-2 rounded-lg text-sm" onchange="renderRosterGrid()">
                         <button onclick="saveRosterChanges()" class="bg-green-600 text-white px-4 py-2 rounded-lg font-bold text-sm shadow hover:bg-green-700 transition">Simpan Perubahan</button>
                    </div>
                </div>
                <div class="overflow-x-auto border rounded-lg">
                    <table class="w-full text-sm text-center border-collapse" id="rosterGridTable">
                        <!-- Grid generated by JS -->
                    </table>
                </div>
            </div>

            <!-- 4. REKAP JAM KERJA -->
            <div id="mgrPage-rekap" class="mgr-page hidden-section bg-white p-6 rounded-xl shadow-sm">
                <h2 class="font-bold text-xl text-gray-800 mb-4">Rekap Jam Kerja Bulanan</h2>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left border-collapse">
                        <thead class="bg-gray-50 text-gray-500">
                            <tr>
                                <th class="p-3">Nama Karyawan</th>
                                <th class="p-3">Total Kehadiran</th>
                                <th class="p-3">Total Terlambat</th>
                                <th class="p-3">Estimasi Jam Kerja</th>
                            </tr>
                        </thead>
                        <tbody id="tableRekap" class="divide-y divide-gray-100"></tbody>
                    </table>
                </div>
            </div>

            <!-- 5. PROGRES TUGAS -->
            <div id="mgrPage-progres" class="mgr-page hidden-section bg-white p-6 rounded-xl shadow-sm">
                <h2 class="font-bold text-xl text-gray-800 mb-4">Monitoring Checklist Harian</h2>
                <div class="space-y-4" id="containerProgres">
                    <!-- Items by JS -->
                </div>
            </div>

            <!-- 6. EDIT JOB DESK -->
            <div id="mgrPage-jobdesk" class="mgr-page hidden-section bg-white p-6 rounded-xl shadow-sm">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="font-bold text-xl text-gray-800">Database Job Desk</h2>
                    <button onclick="openJobDeskModal()" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-blue-700">+ Tambah Tugas</button>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left border-collapse">
                        <thead class="bg-gray-50 text-gray-500">
                            <tr>
                                <th class="p-3">Posisi</th>
                                <th class="p-3">Tugas</th>
                                <th class="p-3">Target</th>
                                <th class="p-3 text-right">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="tableJobDesk" class="divide-y divide-gray-100"></tbody>
                    </table>
                </div>
            </div>

            <!-- 7. DATA KARYAWAN -->
            <div id="mgrPage-karyawan" class="mgr-page hidden-section bg-white p-6 rounded-xl shadow-sm">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="font-bold text-xl text-gray-800">Database Karyawan</h2>
                    <button onclick="openEmployeeModal()" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-blue-700">+ Karyawan Baru</button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="gridKaryawan">
                    <!-- Cards by JS -->
                </div>
            </div>
        </main>
    </div>

    <!-- MODALS -->
    <!-- Modal JobDesk -->
    <div id="modalJobDesk" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl p-6 w-full max-w-md shadow-2xl">
            <h3 class="font-bold text-lg mb-4">Tambah Job Desk</h3>
            <form onsubmit="saveJobDesk(event)" class="space-y-3">
                <select id="jdPosisi" class="w-full border p-2 rounded" required>
                    <option value="">-- Pilih Posisi --</option>
                    <option value="Pramusaji">Pramusaji</option>
                    <option value="Bartender">Bartender</option>
                    <option value="Chef">Chef</option>
                    <option value="Kasir">Kasir</option>
                    <option value="Koordinator">Koordinator</option>
                </select>
                <input type="text" id="jdTugas" placeholder="Nama Tugas" class="w-full border p-2 rounded" required>
                <input type="text" id="jdTarget" placeholder="Target (Opsional)" class="w-full border p-2 rounded">
                <div class="flex justify-end gap-2 pt-2">
                    <button type="button" onclick="closeModal('modalJobDesk')" class="text-gray-500 font-bold px-4 py-2">Batal</button>
                    <button type="submit" class="bg-blue-600 text-white font-bold px-4 py-2 rounded hover:bg-blue-700">Simpan</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Karyawan -->
    <div id="modalKaryawan" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl p-6 w-full max-w-lg shadow-2xl h-3/4 overflow-y-auto">
            <h3 class="font-bold text-lg mb-4">Data Karyawan</h3>
            <form onsubmit="saveEmployee(event)" class="space-y-3 text-sm">
                <input type="hidden" id="empActionType" value="add">
                <div class="grid grid-cols-2 gap-3">
                    <input type="text" id="eId" placeholder="ID (PB...)" class="border p-2 rounded" required>
                    <input type="text" id="eNama" placeholder="Nama Lengkap" class="border p-2 rounded" required>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <select id="ePosisi" class="border p-2 rounded" required>
                        <option value="">Posisi</option>
                        <option value="Manager">Manager</option>
                        <option value="Koordinator">Koordinator</option>
                        <option value="Pramusaji">Pramusaji</option>
                        <option value="Bartender">Bartender</option>
                        <option value="Chef">Chef</option>
                        <option value="Kasir">Kasir</option>
                    </select>
                    <input type="text" id="ePass" placeholder="Password" class="border p-2 rounded" required>
                </div>
                <input type="date" id="eLahir" class="w-full border p-2 rounded">
                <input type="url" id="eFoto" placeholder="URL Foto (Imgur)" class="w-full border p-2 rounded">
                <input type="text" id="eWa" placeholder="No Whatsapp" class="w-full border p-2 rounded">
                <input type="email" id="eEmail" placeholder="Email" class="w-full border p-2 rounded">
                <textarea id="eAlamat" placeholder="Alamat" class="w-full border p-2 rounded"></textarea>
                <div class="grid grid-cols-2 gap-3">
                    <input type="text" id="eNikah" placeholder="Status Pernikahan" class="border p-2 rounded">
                    <input type="text" id="eKontak" placeholder="Kontak Darurat" class="border p-2 rounded">
                </div>
                <input type="text" id="eInisial" placeholder="Inisial (Contoh: IAN)" class="w-full border p-2 rounded">

                <div class="flex justify-end gap-2 pt-4">
                    <button type="button" onclick="closeModal('modalKaryawan')" class="text-gray-500 font-bold px-4 py-2">Batal</button>
                    <button type="submit" class="bg-blue-600 text-white font-bold px-4 py-2 rounded hover:bg-blue-700">Simpan Data</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // === KONFIGURASI ===
        // GANTI URL DI BAWAH INI SETELAH DEPLOY CODE.GS BARU
        const API_URL = "https://script.google.com/macros/s/AKfycbwMq6xFY3uZ2MiJgY_66se6Jwgq2tEtOUV_2ZgZsoY6oWqa2hOXcpyr4U4sjfplnNw9dQ/exec";
        
        const OFFICE_LOC = { lat: -2.171698, lng: 115.402943, radius: 100 }; 

        // State Global
        let currentUser = null;
        let globalData = {};
        let currentPosition = null;
        let isInsideArea = false;
        let livenessPassed = false;
        let selectedMode = 'IN';
        let rosterChanges = {}; // Menyimpan perubahan roster sementara

        // === AUTHENTICATION ===
        async function handleLogin(e) {
            e.preventDefault();
            const id = document.getElementById('loginId').value;
            const pass = document.getElementById('loginPass').value;
            const btn = document.getElementById('btnLogin');
            
            btn.innerText = "Memverifikasi...";
            btn.disabled = true;

            try {
                const res = await fetch(API_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'login', id: id, password: pass })
                });
                const json = await res.json();

                if (json.status === 'success') {
                    currentUser = json.data;
                    currentUser.role = json.role;
                    await loadData();
                    
                    document.getElementById('viewLogin').classList.remove('active-section');
                    document.getElementById('viewLogin').classList.add('hidden-section');

                    if (currentUser.role === 'manager') showManagerView();
                    else showEmployeeView();
                } else {
                    Swal.fire('Gagal', json.message, 'error');
                }
            } catch (err) {
                Swal.fire('Error', 'Koneksi Gagal', 'error');
            } finally {
                btn.innerText = "MASUK APLIKASI";
                btn.disabled = false;
            }
        }

        async function loadData() {
            const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'get_data' }) });
            globalData = await res.json();
        }

        function logout() {
            location.reload();
        }

        // === EMPLOYEE LOGIC ===
        function showEmployeeView() {
            document.getElementById('viewEmployee').classList.remove('hidden-section');
            document.getElementById('viewEmployee').classList.add('active-section');
            
            document.getElementById('empNameDisplay').innerText = currentUser.nama;
            document.getElementById('empPosDisplay').innerText = currentUser.posisi;
            document.getElementById('empPhoto').src = currentUser.foto || `https://ui-avatars.com/api/?name=${currentUser.nama}&background=random`;

            initFaceAPI();
            watchLocation();
            renderEmpRoster();
            renderEmpJobDesk();
            setInterval(updateClock, 1000);
        }

        function switchEmpTab(tab) {
            if (tab === 'absen') {
                document.getElementById('contentEmpAbsen').classList.remove('hidden');
                document.getElementById('contentEmpTugas').classList.add('hidden');
                document.getElementById('tabEmpAbsen').className = "flex-1 py-2 text-sm font-bold rounded-lg bg-blue-100 text-blue-800";
                document.getElementById('tabEmpTugas').className = "flex-1 py-2 text-sm font-bold rounded-lg text-gray-500";
            } else {
                document.getElementById('contentEmpAbsen').classList.add('hidden');
                document.getElementById('contentEmpTugas').classList.remove('hidden');
                document.getElementById('tabEmpTugas').className = "flex-1 py-2 text-sm font-bold rounded-lg bg-blue-100 text-blue-800";
                document.getElementById('tabEmpAbsen').className = "flex-1 py-2 text-sm font-bold rounded-lg text-gray-500";
            }
        }

        function renderEmpRoster() {
            const myRoster = globalData.roster.rows.filter(r => String(r[0]) == String(currentUser.id));
            // Sort by date descending, take top 7
            myRoster.sort((a,b) => new Date(a[1]) - new Date(b[1]));
            // Filter only future/today dates
            const today = new Date();
            today.setHours(0,0,0,0);
            const upcoming = myRoster.filter(r => new Date(r[1]) >= today).slice(0, 7);
            
            let html = '';
            upcoming.forEach(r => {
                const date = new Date(r[1]).toLocaleDateString('id-ID', {weekday: 'short', day: 'numeric', month: 'short'});
                html += `<div class="flex justify-between border-b border-blue-400/30 pb-2"><span>${date}</span><span class="font-bold">${r[2]}</span></div>`;
            });
            document.getElementById('empRosterList').innerHTML = html || '<p class="opacity-70">Belum ada jadwal.</p>';
        }

        function renderEmpJobDesk() {
            const tasks = globalData.jobdesk.rows.filter(t => String(t[0]).toLowerCase() == String(currentUser.posisi).toLowerCase());
            let html = '';
            tasks.forEach(t => {
                html += `
                <label class="flex items-start gap-3 p-3 bg-gray-50 rounded-lg border border-gray-200">
                    <input type="checkbox" class="w-5 h-5 text-green-600 rounded task-checkbox" value="${t[1]}">
                    <div>
                        <p class="font-bold text-gray-700 text-sm">${t[1]}</p>
                        ${t[2] ? `<p class="text-xs text-gray-500">Target: ${t[2]}</p>` : ''}
                    </div>
                </label>`;
            });
            document.getElementById('empTaskList').innerHTML = html || '<p class="text-center text-gray-400">Tidak ada tugas khusus.</p>';
        }

        // === MANAGER LOGIC ===
        function showManagerView() {
            document.getElementById('viewManager').classList.remove('hidden-section');
            document.getElementById('viewManager').classList.add('active-section');
            switchMgrTab('dash');
            updateMgrStats();
        }

        function switchMgrTab(tab) {
            // Hide all
            document.querySelectorAll('.mgr-page').forEach(el => el.classList.add('hidden-section'));
            document.querySelectorAll('.mgr-nav').forEach(el => {
                el.classList.remove('bg-blue-50', 'text-blue-700');
                el.classList.add('text-gray-600');
            });

            // Show active
            document.getElementById(`mgrPage-${tab}`).classList.remove('hidden-section');
            
            // Highlight Nav (Simple approach without ID on buttons)
            // In production, add IDs to buttons for cleaner highlighting
            
            if (tab === 'dash') updateMgrStats();
            if (tab === 'absensi') renderMgrHistory();
            if (tab === 'roster') { 
                document.getElementById('rosterMonthPicker').value = new Date().toISOString().slice(0,7);
                renderRosterGrid(); 
            }
            if (tab === 'rekap') renderMgrRekap();
            if (tab === 'progres') renderMgrProgres();
            if (tab === 'jobdesk') renderMgrJobDesk();
            if (tab === 'karyawan') renderMgrKaryawan();
        }

        // --- 1. Dashboard Stats ---
        function updateMgrStats() {
            const emps = globalData.employees.rows.length;
            const today = new Date().toDateString();
            const attToday = globalData.attendance.rows.filter(r => new Date(r[0]).toDateString() === today && r[3] === 'IN');
            const late = attToday.filter(r => r[4] && r[4].includes('Terlambat')).length;

            document.getElementById('statTotalEmp').innerText = emps;
            document.getElementById('statHadir').innerText = attToday.length;
            document.getElementById('statTelat').innerText = late;
        }

        // --- 2. History ---
        function renderMgrHistory() {
            const data = globalData.attendance.rows.slice().reverse(); // Copy & Reverse
            let html = '';
            data.forEach(r => {
                html += `
                <tr class="border-b hover:bg-gray-50">
                    <td class="p-3 text-gray-500 text-xs">${new Date(r[0]).toLocaleString()}</td>
                    <td class="p-3 font-bold text-gray-800">${r[1]}</td>
                    <td class="p-3 text-xs text-gray-500">${(globalData.employees.rows.find(e=>e[0]==r[2]) || [])[2] || '-'}</td>
                    <td class="p-3"><span class="px-2 py-1 rounded text-xs font-bold ${r[3]=='IN'?'bg-blue-100 text-blue-800':'bg-gray-200 text-gray-600'}">${r[3]}</span></td>
                    <td class="p-3 text-xs">${r[4]} <br> <span class="text-red-500 italic">${r[5]||''}</span></td>
                    <td class="p-3"><a href="${r[8]}" target="_blank" class="text-blue-600 text-xs font-bold underline">Foto</a></td>
                </tr>`;
            });
            document.getElementById('tableHistory').innerHTML = html;
        }

        // --- 3. Roster (Grid) ---
        function renderRosterGrid() {
            const monthVal = document.getElementById('rosterMonthPicker').value;
            if (!monthVal) return;
            
            const year = parseInt(monthVal.split('-')[0]);
            const month = parseInt(monthVal.split('-')[1]) - 1; // 0-based
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            let html = '<thead><tr class="bg-gray-100"><th class="p-2 border sticky left-0 bg-gray-100 z-10">Nama</th>';
            for(let i=1; i<=daysInMonth; i++) {
                const d = new Date(year, month, i);
                const dayName = d.toLocaleDateString('id-ID', {weekday:'narrow'});
                const color = (d.getDay()===0 || d.getDay()===6) ? 'text-red-500' : '';
                html += `<th class="p-2 border min-w-[40px] ${color}">${i}<br><span class="text-[10px]">${dayName}</span></th>`;
            }
            html += '</tr></thead><tbody>';

            globalData.employees.rows.forEach(emp => {
                html += `<tr class="hover:bg-gray-50"><td class="p-2 border font-bold text-left sticky left-0 bg-white z-10">${emp[1]}</td>`;
                
                for(let i=1; i<=daysInMonth; i++) {
                    const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`; // YYYY-MM-DD
                    // Find existing shift
                    // Roster Data: ID [0], Date [1], Shift [2]
                    const rosterEntry = globalData.roster.rows.find(r => String(r[0]) == String(emp[0]) && new Date(r[1]).toISOString().slice(0,10) == dateStr);
                    const currentShift = rosterChanges[`${emp[0]}_${dateStr}`] || (rosterEntry ? rosterEntry[2] : '');
                    
                    // Simple Code: P=Pagi, S=Siang, M=Malam, L=Libur
                    let displayVal = '';
                    if(currentShift === 'Pagi') displayVal = 'P';
                    else if(currentShift === 'Siang') displayVal = 'S';
                    else if(currentShift === 'Malam') displayVal = 'M';
                    else if(currentShift === 'Off') displayVal = 'L';
                    
                    // Color Code
                    let bg = '';
                    if(displayVal === 'P') bg = 'bg-yellow-100';
                    if(displayVal === 'S') bg = 'bg-orange-100';
                    if(displayVal === 'M') bg = 'bg-blue-100';
                    if(displayVal === 'L') bg = 'bg-gray-200';

                    html += `<td class="p-1 border ${bg} cursor-pointer hover:ring-2 ring-blue-500" onclick="editRosterCell(this, '${emp[0]}', '${dateStr}')">${displayVal}</td>`;
                }
                html += '</tr>';
            });
            html += '</tbody>';
            document.getElementById('rosterGridTable').innerHTML = html;
        }

        function editRosterCell(cell, id, date) {
            // Cycle shift: Empty -> Pagi -> Siang -> Malam -> Off -> Empty
            const shifts = ['', 'Pagi', 'Siang', 'Malam', 'Off'];
            const codes = {'': '', 'Pagi': 'P', 'Siang': 'S', 'Malam': 'M', 'Off': 'L'};
            
            const currentText = cell.innerText;
            let currentIdx = -1;
            if (currentText === 'P') currentIdx = 1;
            else if (currentText === 'S') currentIdx = 2;
            else if (currentText === 'M') currentIdx = 3;
            else if (currentText === 'L') currentIdx = 4;
            else currentIdx = 0;

            const nextIdx = (currentIdx + 1) % shifts.length;
            const nextShift = shifts[nextIdx];
            
            // Update Visual
            cell.innerText = codes[nextShift];
            cell.className = `p-1 border cursor-pointer hover:ring-2 ring-blue-500 ${nextShift==='Pagi'?'bg-yellow-100':nextShift==='Siang'?'bg-orange-100':nextShift==='Malam'?'bg-blue-100':nextShift==='Off'?'bg-gray-200':''}`;
            
            // Store Change
            rosterChanges[`${id}_${date}`] = nextShift;
        }

        async function saveRosterChanges() {
            const keys = Object.keys(rosterChanges);
            if (keys.length === 0) return Swal.fire('Info', 'Tidak ada perubahan.', 'info');
            
            Swal.showLoading();
            const dataToSend = keys.map(k => {
                const [id, date] = k.split('_');
                return { id: id, tanggal: date, shift: rosterChanges[k] };
            });

            await fetch(API_URL, {
                method: 'POST',
                body: JSON.stringify({ action: 'manager_action', target: 'roster', type: 'save_roster', data: dataToSend })
            });

            rosterChanges = {};
            await loadData(); // Reload fresh data
            Swal.fire('Sukses', 'Roster berhasil disimpan.', 'success');
        }

        // --- 4. Rekap Jam Kerja (Simple Logic) ---
        function renderMgrRekap() {
            // Logic: Hitung jumlah 'IN' per bulan. (Durasi butuh OUT, di sini kita hitung kehadiran dulu)
            // Anda bisa kembangkan logic durasi (OUT - IN) jika data OUT konsisten.
            const html = globalData.employees.rows.map(emp => {
                const myAtt = globalData.attendance.rows.filter(a => a[2] == emp[0] && a[3] == 'IN');
                const late = myAtt.filter(a => a[4] && a[4].includes('Terlambat')).length;
                // Estimasi jam kerja: Hadir * 8 Jam (Contoh)
                const jam = myAtt.length * 8; 
                
                return `
                <tr class="border-b hover:bg-gray-50">
                    <td class="p-3 font-bold">${emp[1]}</td>
                    <td class="p-3 text-center">${myAtt.length} Hari</td>
                    <td class="p-3 text-center text-red-600 font-bold">${late}</td>
                    <td class="p-3 text-center">${jam} Jam</td>
                </tr>`;
            }).join('');
            document.getElementById('tableRekap').innerHTML = html;
        }

        // --- 5. Progres Tugas ---
        function renderMgrProgres() {
            const today = new Date().toDateString();
            // Group checklists by Emp ID
            const checksToday = globalData.checklist.rows.filter(c => new Date(c[0]).toDateString() === today);
            
            let html = '';
            globalData.employees.rows.forEach(emp => {
                const myChecks = checksToday.filter(c => c[1] == emp[0]);
                const myTasksTotal = globalData.jobdesk.rows.filter(j => j[0].toLowerCase() == emp[2].toLowerCase()).length;
                const pct = myTasksTotal > 0 ? Math.round((myChecks.length / myTasksTotal) * 100) : 0;
                
                html += `
                <div class="bg-white p-4 rounded-lg border border-gray-200 flex justify-between items-center">
                    <div>
                        <p class="font-bold text-gray-800">${emp[1]}</p>
                        <p class="text-xs text-gray-500">${emp[2]}</p>
                    </div>
                    <div class="w-1/3">
                        <div class="flex justify-between text-xs mb-1">
                            <span>Progress</span>
                            <span class="font-bold">${pct}%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2.5">
                            <div class="bg-blue-600 h-2.5 rounded-full" style="width: ${pct}%"></div>
                        </div>
                    </div>
                </div>`;
            });
            document.getElementById('containerProgres').innerHTML = html;
        }

        // --- 6. Job Desk CRUD ---
        function renderMgrJobDesk() {
            const html = globalData.jobdesk.rows.map(j => `
                <tr class="border-b hover:bg-gray-50">
                    <td class="p-3 font-bold text-gray-600">${j[0]}</td>
                    <td class="p-3">${j[1]}</td>
                    <td class="p-3 text-xs bg-gray-100 rounded">${j[2] || '-'}</td>
                    <td class="p-3 text-right">
                        <button onclick="deleteJobDesk('${j[0]}', '${j[1]}')" class="text-red-500 hover:text-red-700"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `).join('');
            document.getElementById('tableJobDesk').innerHTML = html;
        }

        function openJobDeskModal() {
            document.getElementById('modalJobDesk').classList.remove('hidden');
        }

        async function saveJobDesk(e) {
            e.preventDefault();
            const data = {
                posisi: document.getElementById('jdPosisi').value,
                tugas: document.getElementById('jdTugas').value,
                target: document.getElementById('jdTarget').value
            };
            closeModal('modalJobDesk');
            Swal.showLoading();
            await fetch(API_URL, {
                method: 'POST',
                body: JSON.stringify({ action: 'manager_action', target: 'jobdesk', type: 'add', data: data })
            });
            await loadData();
            renderMgrJobDesk();
            Swal.fire('Sukses', 'Job desk ditambahkan', 'success');
        }

        async function deleteJobDesk(posisi, tugas) {
            if(!confirm('Hapus tugas ini?')) return;
            await fetch(API_URL, {
                method: 'POST',
                body: JSON.stringify({ action: 'manager_action', target: 'jobdesk', type: 'delete', data: {posisi, tugas} })
            });
            await loadData();
            renderMgrJobDesk();
        }

        // --- 7. Karyawan CRUD ---
        function renderMgrKaryawan() {
            const html = globalData.employees.rows.map(e => `
                <div class="bg-white p-4 rounded-xl border border-gray-200 shadow-sm hover:shadow-md transition relative">
                    <div class="flex items-center gap-4">
                        <img src="${e[5] || 'https://ui-avatars.com/api/?name='+e[1]}" class="w-16 h-16 rounded-full object-cover bg-gray-200">
                        <div>
                            <p class="font-bold text-gray-800">${e[1]}</p>
                            <p class="text-xs text-blue-600 font-bold bg-blue-50 px-2 py-0.5 rounded inline-block">${e[2]}</p>
                            <p class="text-xs text-gray-400 mt-1">ID: ${e[0]}</p>
                        </div>
                    </div>
                    <div class="mt-4 flex gap-2 border-t pt-3">
                        <button onclick="editEmployee('${e[0]}')" class="flex-1 text-xs font-bold text-blue-600 hover:bg-blue-50 py-2 rounded">EDIT</button>
                        <button onclick="deleteEmployee('${e[0]}')" class="flex-1 text-xs font-bold text-red-600 hover:bg-red-50 py-2 rounded">HAPUS</button>
                    </div>
                </div>
            `).join('');
            document.getElementById('gridKaryawan').innerHTML = html;
        }

        function openEmployeeModal(id = null) {
            document.getElementById('modalKaryawan').classList.remove('hidden');
            if(id) {
                // Edit Mode: Populate data
                const emp = globalData.employees.rows.find(r => r[0] == id);
                document.getElementById('empActionType').value = 'edit';
                document.getElementById('eId').value = emp[0];
                document.getElementById('eNama').value = emp[1];
                document.getElementById('ePosisi').value = emp[2];
                document.getElementById('ePass').value = emp[3];
                document.getElementById('eLahir').value = formatDateForInput(emp[4]);
                document.getElementById('eFoto').value = emp[5];
                document.getElementById('eWa').value = emp[6];
                document.getElementById('eEmail').value = emp[7];
                document.getElementById('eAlamat').value = emp[8];
                document.getElementById('eNikah').value = emp[9];
                document.getElementById('eKontak').value = emp[10];
                document.getElementById('eInisial').value = emp[11];
                document.getElementById('eId').readOnly = true; // ID cannot change
            } else {
                // Add Mode
                document.getElementById('empActionType').value = 'add';
                document.querySelector('#modalKaryawan form').reset();
                document.getElementById('eId').readOnly = false;
            }
        }

        function editEmployee(id) { openEmployeeModal(id); }

        async function saveEmployee(e) {
            e.preventDefault();
            const type = document.getElementById('empActionType').value;
            const data = {
                id: document.getElementById('eId').value,
                nama: document.getElementById('eNama').value,
                posisi: document.getElementById('ePosisi').value,
                password: document.getElementById('ePass').value,
                tgl_lahir: document.getElementById('eLahir').value,
                foto_url: document.getElementById('eFoto').value,
                wa: document.getElementById('eWa').value,
                email: document.getElementById('eEmail').value,
                alamat: document.getElementById('eAlamat').value,
                status_nikah: document.getElementById('eNikah').value,
                kontak_darurat: document.getElementById('eKontak').value,
                inisial: document.getElementById('eInisial').value
            };

            closeModal('modalKaryawan');
            Swal.showLoading();
            
            await fetch(API_URL, {
                method: 'POST',
                body: JSON.stringify({ action: 'manager_action', target: 'employee', type: type, data: data })
            });
            await loadData();
            renderMgrKaryawan();
            Swal.fire('Sukses', 'Data Karyawan Disimpan', 'success');
        }

        async function deleteEmployee(id) {
            if(!confirm('Hapus karyawan ini?')) return;
            await fetch(API_URL, {
                method: 'POST',
                body: JSON.stringify({ action: 'manager_action', target: 'employee', type: 'delete', data: {id: id} })
            });
            await loadData();
            renderMgrKaryawan();
        }

        // === UTILS ===
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
        function updateClock() { 
            const d = new Date(); 
            if(document.getElementById('serverTime')) document.getElementById('serverTime').innerText = d.toLocaleTimeString('id-ID', {hour:'2-digit', minute:'2-digit'}); 
        }
        function formatDateForInput(dateStr) {
            if(!dateStr) return '';
            const d = new Date(dateStr);
            return d.toISOString().split('T')[0];
        }
        
        // Camera & GPS Utils (Same as before)
        async function initFaceAPI() {
             try {
                await Promise.all([
                    faceapi.nets.tinyFaceDetector.loadFromUri('https://cdn.jsdelivr.net/gh/justadudewhohacks/face-api.js@0.22.2/weights'),
                    faceapi.nets.faceLandmark68TinyNet.loadFromUri('https://cdn.jsdelivr.net/gh/justadudewhohacks/face-api.js@0.22.2/weights')
                ]);
                const video = document.getElementById('video');
                navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } }).then(stream => {
                    video.srcObject = stream;
                    video.addEventListener('play', () => {
                        const canvas = document.getElementById('overlay');
                        faceapi.matchDimensions(canvas, { width: video.offsetWidth, height: video.offsetHeight });
                        setInterval(async () => {
                            if(livenessPassed) return;
                            const det = await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks(true);
                            if(det) {
                                livenessPassed = true;
                                document.getElementById('instructionBox').innerText = "Wajah OK ✅";
                                document.getElementById('instructionBox').className = "bg-green-600 text-white px-3 py-1 rounded-full text-xs font-bold";
                                document.getElementById('cameraFrame').className += " liveness-success";
                                checkReadyState();
                            }
                        }, 500);
                    });
                });
             } catch(e) { console.log(e); }
        }

        function watchLocation() {
            if(!navigator.geolocation) return;
            navigator.geolocation.watchPosition(p => {
                currentPosition = p;
                const d = getDist(p.coords.latitude, p.coords.longitude, OFFICE_LOC.lat, OFFICE_LOC.lng);
                if(d > OFFICE_LOC.radius) {
                    isInsideArea = false;
                    document.getElementById('gpsStatus').innerText = "Luar Area (" + Math.round(d) + "m)";
                    document.getElementById('gpsStatus').className = "text-sm font-bold text-red-600 mt-0.5";
                    document.getElementById('reasonContainer').classList.remove('hidden');
                } else {
                    isInsideArea = true;
                    document.getElementById('gpsStatus').innerText = "Di Area Kantor ✅";
                    document.getElementById('gpsStatus').className = "text-sm font-bold text-green-600 mt-0.5";
                    document.getElementById('reasonContainer').classList.add('hidden');
                    document.getElementById('attendanceReason').value = "";
                }
                checkReadyState();
            });
        }

        function getDist(lat1, lon1, lat2, lon2) {
            var R = 6371000; 
            var dLat = (lat2-lat1) * (Math.PI/180);
            var dLon = (lon2-lon1) * (Math.PI/180); 
            var a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1*(Math.PI/180)) * Math.cos(lat2*(Math.PI/180)) * Math.sin(dLon/2) * Math.sin(dLon/2); 
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
        }

        function setMode(m) {
            selectedMode = m;
            // Simple toggle UI logic
            const btnIn = document.getElementById('btnIn');
            const btnOut = document.getElementById('btnOut');
            if(m==='IN') {
                btnIn.className = "py-3 border-2 rounded-xl font-bold text-sm border-blue-600 bg-blue-600 text-white";
                btnOut.className = "py-3 border-2 rounded-xl font-bold text-sm border-gray-200 text-gray-500";
            } else {
                btnOut.className = "py-3 border-2 rounded-xl font-bold text-sm border-red-600 bg-red-600 text-white";
                btnIn.className = "py-3 border-2 rounded-xl font-bold text-sm border-gray-200 text-gray-500";
            }
            checkReadyState();
        }

        function checkReadyState() {
            const btn = document.getElementById('btnSubmit');
            const reason = document.getElementById('attendanceReason').value;
            const locationOK = isInsideArea || (!isInsideArea && reason !== "");
            
            if(livenessPassed && locationOK) {
                btn.disabled = false;
                btn.className = "w-full py-4 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-xl shadow-lg transition-all transform active:scale-95";
                btn.innerText = `KIRIM ABSEN ${selectedMode}`;
            } else {
                btn.disabled = true;
                btn.className = "w-full py-4 bg-gray-300 text-gray-500 font-bold rounded-xl shadow-none cursor-not-allowed";
                if(!livenessPassed) btn.innerText = "WAJAH BELUM TERDETEKSI";
                else btn.innerText = "LOKASI / ALASAN BELUM LENGKAP";
            }
        }

        async function submitAttendance() {
            Swal.showLoading();
            const video = document.getElementById('video');
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth; canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            
            const reason = document.getElementById('attendanceReason').value;
            const now = new Date();
            
            let statusDetail = "Tepat Waktu";
            if(selectedMode === 'IN' && now.getHours() >= 8 && now.getMinutes() > 30) statusDetail = "Terlambat";
            if(!isInsideArea) statusDetail += " (Luar Area)";

            const payload = {
                action: 'submit_attendance',
                id: currentUser.id,
                nama: currentUser.nama,
                timestamp: now.toISOString(),
                status: selectedMode,
                status_detail: statusDetail,
                alasan: isInsideArea ? "Di Kantor" : reason,
                lat: currentPosition.coords.latitude,
                lng: currentPosition.coords.longitude,
                foto: canvas.toDataURL('image/jpeg', 0.6)
            };

            await fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) });
            Swal.fire('Sukses', 'Absensi Berhasil', 'success').then(()=> location.reload());
        }

        async function submitChecklist() {
            const checks = document.querySelectorAll('.task-checkbox:checked');
            if(checks.length === 0) return Swal.fire('Info', 'Pilih minimal 1 tugas', 'info');
            
            Swal.showLoading();
            const items = Array.from(checks).map(c => c.value);
            await fetch(API_URL, {
                method: 'POST',
                body: JSON.stringify({ action: 'submit_checklist', id: currentUser.id, items: items })
            });
            Swal.fire('Sukses', 'Laporan Terkirim', 'success');
        }

        init();
    </script>
</body>
</html>
