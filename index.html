// ID Sheet Anda
const SPREADSHEET_ID = '1ZQ1Tn-sOSgnTcmSpIzIl0lg7p_mwlc-43Ov2ThnTkeI';

function doGet(e) {
  const action = e.parameter.action;
  if (action == 'getData') return getAllData();
  return ContentService.createTextOutput("Server Ready");
}

function doPost(e) {
  try {
    const data = JSON.parse(e.postData.contents);
    const action = data.action;
    
    if (action == 'clockIn') return handleClockIn(data);
    else if (action == 'clockOut') return handleClockOut(data);
    else if (action == 'updateRoster') return handleUpdateRoster(data);
    else if (action == 'permission') return handlePermission(data);
    else if (action == 'manageEmployee') return handleManageEmployee(data);
    
    return responseJSON({ status: 'error', message: 'Unknown action' });
  } catch (error) {
    return responseJSON({ status: 'error', message: error.toString() });
  }
}

function getAllData() {
  const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
  return responseJSON({
    employees: mapEmployees(getSheetData(ss, 'Karyawan')),
    roster: mapRoster(getSheetData(ss, 'Roster')),
    jobDesk: mapJobDesk(getSheetData(ss, 'JobDesk')),
    announcements: getSheetData(ss, 'Pengumuman'),
    attendance: mapAttendance(getSheetData(ss, 'Absensi'))
  });
}

function handleManageEmployee(data) {
  const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
  const sheet = ss.getSheetByName('Karyawan');
  const subAction = data.subAction;
  const emp = data.employee;
  
  const rowData = [
    emp.id, emp.name, emp.position, emp.pass, emp.birthDate, emp.photo, 
    emp.phone, emp.email, emp.address, emp.maritalStatus, emp.emergency, emp.initial, emp.joinDate
  ];

  if (subAction === 'add') {
    const ids = sheet.getRange(2, 1, sheet.getLastRow(), 1).getValues().flat();
    if (ids.includes(emp.id)) return responseJSON({ status: 'error', message: 'ID Karyawan sudah ada!' });
    sheet.appendRow(rowData);
    return responseJSON({ status: 'success', message: 'Karyawan berhasil ditambahkan' });
  } else if (subAction === 'edit') {
    const rows = sheet.getDataRange().getValues();
    for (let i = 1; i < rows.length; i++) {
      if (rows[i][0] == emp.id) {
        sheet.getRange(i + 1, 1, 1, rowData.length).setValues([rowData]);
        return responseJSON({ status: 'success', message: 'Data karyawan diperbarui' });
      }
    }
    return responseJSON({ status: 'error', message: 'Karyawan tidak ditemukan' });
  } else if (subAction === 'delete') {
    const rows = sheet.getDataRange().getValues();
    for (let i = 1; i < rows.length; i++) {
      if (rows[i][0] == emp.id) {
        sheet.deleteRow(i + 1);
        return responseJSON({ status: 'success', message: 'Karyawan dihapus' });
      }
    }
  }
  return responseJSON({ status: 'error', message: 'Aksi gagal' });
}

function handleClockIn(data) {
  const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
  const sheet = ss.getSheetByName('Absensi');
  sheet.appendRow([data.date, data.empId, data.clockIn, "", data.status, data.lat, data.lng]);
  return responseJSON({ status: 'success', message: 'Clock In Berhasil' });
}

function handleClockOut(data) {
  const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
  const sheet = ss.getSheetByName('Absensi');
  const rows = sheet.getDataRange().getValues();
  for (let i = 1; i < rows.length; i++) {
    if (formatDate(new Date(rows[i][0])) === data.date && rows[i][1] === data.empId) {
      sheet.getRange(i + 1, 4).setValue(data.clockOut);
      return responseJSON({ status: 'success', message: 'Clock Out Berhasil' });
    }
  }
  return responseJSON({ status: 'error', message: 'Data tidak ditemukan' });
}

function handleUpdateRoster(data) {
  const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
  const sheet = ss.getSheetByName('Roster');
  const values = sheet.getDataRange().getValues();
  data.updates.forEach(u => {
    let found = false;
    for (let i = 1; i < values.length; i++) {
      if (formatDate(new Date(values[i][1])) === u.date && values[i][2] === u.id) {
        sheet.getRange(i + 1, 4).setValue(u.shift);
        found = true; break;
      }
    }
    if (!found) sheet.appendRow(['J'+Math.floor(Math.random()*1000), u.date, u.id, u.shift, u.start, u.end]);
  });
  return responseJSON({ status: 'success' });
}

function handlePermission(data) {
  const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
  const sheet = ss.getSheetByName('Absensi');
  sheet.appendRow([data.date, data.empId, "-", "-", `${data.type}: ${data.reason}`, "-", "-"]);
  return responseJSON({ status: 'success', message: 'Pengajuan berhasil dikirim' });
}

function mapEmployees(rows) {
  return rows.map(r => ({
    id: r['ID_Karyawan'], name: r['Nama_Lengkap'], position: r['Posisi'], pass: r['password'],
    birthDate: formatDate(r['Tanggal_Lahir']), photo: r['Foto_URL'], phone: r['No_Whatsapp'],
    email: r['email'], address: r['Alamat'], maritalStatus: r['Status_Pernikahan'],
    emergency: r['Kontak_Darurat'], initial: r['Foto_Inisial'], joinDate: formatDate(r['Tanggal_Bergabung'])
  }));
}
function mapRoster(rows) { return rows.map(r => ({ id: r['ID_Karyawan'], date: formatDate(r['Tanggal']), shift: r['Nama_Shift'], start: r['Jam_Mulai'], end: r['Jam_Selesai'] })); }
function mapJobDesk(rows) { return rows.map(r => ({ position: r['Posisi'], task: r['Tugas'], target: r['Target'] })); }
function mapAttendance(rows) { return rows.map(r => ({ date: formatDate(r['Tanggal']), empId: r['ID_Karyawan'], clockIn: r['Clock_In'], clockOut: r['Clock_Out'], status: r['Status'], lat: r['Lat'], lng: r['Lng'] })); }
function getSheetData(ss, name) { const s = ss.getSheetByName(name); return s ? s.getDataRange().getValues().slice(1).map(r => { const h = s.getDataRange().getValues()[0]; return h.reduce((o, k, i) => ({...o, [k]: r[i]}), {}); }) : []; }
function responseJSON(data) { return ContentService.createTextOutput(JSON.stringify(data)).setMimeType(ContentService.MimeType.JSON); }
function formatDate(d) { if(!d || d == '') return ''; try { return new Date(d).toISOString().split('T')[0]; } catch(e) { return ''; } }
