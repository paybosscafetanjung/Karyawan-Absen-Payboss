<!doctype html>
<html lang="id">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PayBoss Cafe - Sistem Absensi</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 0; height: 100%; }
    html { height: 100%; }
    .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .gradient-success { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); }
    .card-shadow { box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
    .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); transition: transform 0.2s; }
    .btn-primary:hover { transform: scale(1.05); }
    .btn-success { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); }
    .btn-danger { background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%); }
    .toast { position: fixed; top: 20px; right: 20px; padding: 16px 24px; background: white; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); z-index: 10000; animation: slideIn 0.3s ease-out; border-left: 4px solid; max-width: 400px; }
    .toast.success { border-left-color: #10b981; }
    .toast.error { border-left-color: #ef4444; }
    @keyframes slideIn { from { transform: translateX(400px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); display: flex; align-items: center; justify-content: center; z-index: 9999; padding: 20px; overflow-y: auto; }
    .modal-content { background: white; border-radius: 20px; padding: 30px; max-width: 700px; width: 100%; max-height: 90%; overflow-y: auto; }
    .job-desk-item { transition: all 0.3s ease; cursor: pointer; }
    .job-desk-item:hover { background: #fef3c7; transform: translateX(5px); }
    .job-desk-item.checked { background: #d1fae5; border-color: #10b981; }
    .checkbox-custom { width: 22px; height: 22px; cursor: pointer; accent-color: #10b981; }
    .page-container { min-height: 100%; display: flex; flex-direction: column; }
    .scrollable-content { flex: 1; overflow-y: auto; padding: 24px; }
    .tab-button { padding: 12px 24px; font-weight: bold; border-radius: 12px; transition: all 0.3s; cursor: pointer; }
    .tab-button.active { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
    .tab-button:not(.active) { background: white; color: #6b7280; }
    .tab-button:not(.active):hover { background: #f3f4f6; }
    .roster-card { transition: all 0.3s; }
    .roster-card.today { border: 3px solid #10b981; box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.2); }
    .shift-badge { padding: 8px 16px; border-radius: 12px; font-weight: bold; font-size: 14px; }
    .shift-pagi { background: #FEF3C7; color: #92400E; }
    .shift-siang { background: #FED7AA; color: #9A3412; }
    .shift-malam { background: #DBEAFE; color: #1E3A8A; }
    .shift-off { background: #F3F4F6; color: #6B7280; }
    .status-pending { background: #FEF3C7; color: #92400E; }
    .status-approved { background: #D1FAE5; color: #065F46; }
    .status-rejected { background: #FEE2E2; color: #991B1B; }
    
    /* CAMERA & GPS UI */
    .camera-view { width: 100%; border-radius: 12px; background: #000; overflow: hidden; position: relative; min-height: 240px; }
    video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
    .captured-photo { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: 10; display: none; }
    .hidden { display: none; }
    
    /* ROSTER GRID */
    .roster-table th, .roster-table td { border: 1px solid #e5e7eb; padding: 8px; text-align: center; min-width: 80px; }
    .roster-table th:first-child, .roster-table td:first-child { position: sticky; left: 0; background: white; z-index: 10; border-right: 2px solid #e5e7eb; min-width: 120px; text-align: left; }
    .roster-cell { cursor: pointer; transition: all 0.2s; border-radius: 8px; padding: 8px 4px; font-size: 12px; font-weight: bold; }
    .roster-cell:hover { transform: scale(1.05); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .shift-pagi { background-color: #FEF3C7; color: #92400E; border: 1px solid #F59E0B; }
    .shift-siang { background-color: #FFEDD5; color: #9A3412; border: 1px solid #EA580C; }
    .shift-malam { background-color: #DBEAFE; color: #1E3A8A; border: 1px solid #2563EB; }
    .shift-off { background-color: #F3F4F6; color: #6B7280; border: 1px solid #D1D5DB; }
  </style>
 </head>
 <body class="bg-gray-100">
  <!-- LOGIN SCREEN -->
  <div id="login-screen" class="min-h-full gradient-bg flex items-center justify-center p-6">
   <div class="bg-white rounded-3xl p-10 max-w-md w-full card-shadow text-center">
    <div class="text-6xl mb-4">‚òï</div><h1 class="text-4xl font-bold text-gray-800 mb-2">PayBoss Cafe</h1><p class="text-gray-500 mb-8">Sistem Absensi Terintegrasi</p>
    <form onsubmit="handleLogin(event)" class="space-y-4 text-left">
      <div><label class="block text-sm font-bold text-gray-700 mb-1">Username / ID</label><input type="text" id="login-username" required class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl" placeholder="manager / EMP..."></div>
      <div><label class="block text-sm font-bold text-gray-700 mb-1">Password</label><input type="password" id="login-password" required class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl" placeholder="******"></div>
      <button type="submit" id="btn-login" class="w-full btn-primary text-white font-bold py-3 rounded-xl shadow-lg hover:opacity-90 transition">üöÄ LOGIN MASUK</button>
    </form>
   </div>
  </div>

  <!-- MANAGER DASHBOARD -->
  <div id="manager-dashboard" class="hidden page-container">
   <header class="bg-white shadow-lg border-b-4 border-purple-600 p-6">
    <div class="flex justify-between items-center max-w-7xl mx-auto">
     <div><h1 class="text-3xl font-bold text-gray-800">Dashboard Manager</h1><p class="text-gray-600">PayBoss Cafe</p></div>
     <button onclick="logout()" class="px-6 py-2 bg-red-600 text-white font-bold rounded-lg">Logout</button>
    </div>
   </header>
   <div class="bg-white shadow-md p-4">
    <div class="max-w-7xl mx-auto flex gap-4 flex-wrap">
      <button onclick="showManagerTab('employees')" id="tab-employees" class="tab-button active">üë• Karyawan</button> 
      <button onclick="showManagerTab('attendance')" id="tab-attendance" class="tab-button">üìä Absensi</button>
      <button onclick="showManagerTab('roster')" id="tab-roster" class="tab-button">üìÖ Roster</button>
      <button onclick="showManagerTab('report')" id="tab-report" class="tab-button">üìà Laporan</button>
      <button onclick="showManagerTab('leave')" id="tab-leave" class="tab-button">üìÑ Izin</button>
    </div>
   </div>
   <div class="scrollable-content max-w-7xl mx-auto w-full">
    <!-- Stats -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
     <div class="bg-white rounded-2xl p-6 card-shadow border-l-4 border-blue-500"><div><p class="text-gray-600 text-xs">Total Karyawan</p><p id="stat-total-employees" class="text-2xl font-bold">0</p></div></div>
     <div class="bg-white rounded-2xl p-6 card-shadow border-l-4 border-green-500"><div><p class="text-gray-600 text-xs">Hadir Hari Ini</p><p id="stat-present-today" class="text-2xl font-bold">0</p></div></div>
     <div class="bg-white rounded-2xl p-6 card-shadow border-l-4 border-yellow-500"><div><p class="text-gray-600 text-xs">Pending Izin</p><p id="stat-pending-leaves" class="text-2xl font-bold">0</p></div></div>
    </div>
    
    <!-- TAB: Employees -->
    <div id="manager-tab-employees" class="tab-content">
     <div class="bg-white rounded-2xl p-8 card-shadow mb-8">
      <div class="flex justify-between items-center mb-6"><h2 class="text-2xl font-bold">üë• Karyawan</h2><button onclick="showEmployeeForm()" class="btn-primary text-white px-6 py-3 rounded-xl font-bold">‚ûï Tambah</button></div>
      <div id="employee-form" class="hidden mb-8 p-8 bg-purple-50 rounded-2xl">
       <form onsubmit="saveEmployee(event)" class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <input type="text" id="emp-id" readonly class="w-full p-3 border rounded-xl bg-gray-100">
        <input type="text" id="emp-name" required class="w-full p-3 border rounded-xl" placeholder="Nama">
        <select id="emp-position" required class="w-full p-3 border rounded-xl">
            <option value="Barista">Barista</option>
            <option value="Bartender">Bartender</option>
            <option value="Kasir">Kasir</option>
            <option value="Pelayan">Pelayan</option>
            <option value="Pramusaji">Pramusaji</option>
            <option value="Chef">Chef</option>
            <option value="Supervisor">Supervisor</option>
            <option value="Manager">Manager</option>
            <option value="Security">Security</option>
            <option value="Admin">Admin</option>
        </select>
        <input type="tel" id="emp-phone" required class="w-full p-3 border rounded-xl" placeholder="Telepon">
        <input type="email" id="emp-email" required class="w-full p-3 border rounded-xl" placeholder="Email">
        <input type="text" id="emp-password" required placeholder="Password Login" class="w-full p-3 border rounded-xl">
        <div class="md:col-span-2 flex gap-4 mt-4"><button type="submit" id="btn-save-employee" class="flex-1 btn-success text-white font-bold py-3 rounded-xl">Simpan</button><button type="button" onclick="hideEmployeeForm()" class="flex-1 bg-gray-500 text-white font-bold py-3 rounded-xl">Batal</button></div>
       </form>
      </div>
      <div id="employee-list" class="space-y-4"></div>
     </div>
    </div>

    <!-- TAB: Attendance (UPDATED WITH LIVE MONITOR & STATUS) -->
    <div id="manager-tab-attendance" class="tab-content hidden">
      
      <!-- LIVE SHIFT MONITOR -->
      <div class="bg-gradient-to-r from-blue-600 to-purple-600 rounded-2xl p-6 card-shadow mb-8 text-white">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-2xl font-bold flex items-center gap-2">üì° Live Shift Monitor <span class="text-xs bg-white bg-opacity-20 px-2 py-1 rounded">Hari Ini</span></h2>
            <div class="text-sm bg-white bg-opacity-20 px-3 py-1 rounded-full" id="monitor-date-display">...</div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4" id="shift-monitor-grid">
            <div class="bg-white bg-opacity-10 rounded-xl p-4 animate-pulse">Loading...</div>
        </div>
      </div>

      <div class="bg-white rounded-2xl p-8 card-shadow">
        <div class="flex flex-wrap justify-between items-center mb-6">
          <h2 class="text-2xl font-bold text-gray-800">üìä Log Absensi Lengkap</h2>
          <div class="flex items-center gap-2">
            <label class="text-sm font-bold text-gray-600">Pilih Tanggal:</label>
            <input type="date" id="manager-att-date" onchange="renderManagerAttendance()" class="p-2 border rounded-xl bg-gray-50">
          </div>
        </div>
        <div id="manager-attendance-list" class="space-y-4"></div>
      </div>
    </div>
    
    <!-- TAB: Roster -->
    <div id="manager-tab-roster" class="tab-content hidden">
      <div class="bg-white rounded-2xl p-8 card-shadow">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold">üìÖ Jadwal Kerja</h2>
            <div class="flex gap-2 items-center bg-gray-100 p-1 rounded-lg">
                <button onclick="changeRosterWeek(-1)" class="px-3 py-1 bg-white rounded shadow text-sm font-bold">&lt;</button>
                <span id="roster-period-label" class="px-3 text-sm font-bold">Minggu Ini</span>
                <button onclick="changeRosterWeek(1)" class="px-3 py-1 bg-white rounded shadow text-sm font-bold">&gt;</button>
            </div>
        </div>
        <div class="overflow-x-auto">
            <table class="roster-table w-full text-sm">
                <thead><tr class="bg-gray-100" id="roster-header-row"><th class="p-4">Karyawan</th></tr></thead>
                <tbody id="roster-grid-body"></tbody>
            </table>
        </div>
      </div>
    </div>

    <!-- TAB: REPORT -->
    <div id="manager-tab-report" class="tab-content hidden">
        <div class="bg-white rounded-2xl p-8 card-shadow">
            <div class="flex flex-wrap items-end gap-4 mb-8 bg-blue-50 p-6 rounded-xl border border-blue-100">
                <div class="flex-1 min-w-[200px]">
                    <label class="block text-sm font-bold text-gray-700 mb-2">üìÖ Dari Tanggal</label>
                    <input type="date" id="report-start" class="w-full p-3 border rounded-xl shadow-sm">
                </div>
                <div class="flex-1 min-w-[200px]">
                    <label class="block text-sm font-bold text-gray-700 mb-2">üìÖ Sampai Tanggal</label>
                    <input type="date" id="report-end" class="w-full p-3 border rounded-xl shadow-sm">
                </div>
                <button onclick="generateReport()" class="btn-primary text-white px-8 py-3 rounded-xl font-bold shadow-lg hover:shadow-xl transition">
                    üîç Tampilkan Laporan
                </button>
            </div>

            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="bg-gray-100 text-gray-700">
                            <th class="p-4 rounded-tl-xl border-b-2">Nama Karyawan</th>
                            <th class="p-4 border-b-2">Jabatan</th>
                            <th class="p-4 border-b-2 text-center">Jml Kehadiran</th>
                            <th class="p-4 border-b-2 text-center">Total Jam Kerja</th>
                            <th class="p-4 rounded-tr-xl border-b-2 text-center">Total Lembur</th>
                        </tr>
                    </thead>
                    <tbody id="report-table-body" class="text-gray-600">
                        <tr><td colspan="5" class="p-8 text-center text-gray-400">Silakan pilih rentang tanggal untuk melihat laporan.</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- TAB: Leave -->
    <div id="manager-tab-leave" class="tab-content hidden"><div class="bg-white rounded-2xl p-8 card-shadow"><h2 class="text-2xl font-bold mb-6">üìÑ Izin Masuk</h2><div id="manager-leave-list" class="space-y-4"></div></div></div>
   </div>
  </div>

  <!-- EMPLOYEE DASHBOARD -->
  <div id="employee-dashboard" class="hidden page-container">
   <header class="gradient-success text-white shadow-lg p-6">
    <div class="max-w-7xl mx-auto flex justify-between items-center">
     <div><h1 class="text-3xl font-bold mb-1">Halo, <span id="emp-dash-name">User</span></h1><p class="text-green-100">PayBoss Employee</p></div>
     <button onclick="logout()" class="px-6 py-2 bg-white bg-opacity-20 rounded-lg font-bold">Logout</button>
    </div>
   </header>
   <div class="bg-white shadow-md p-4">
    <div class="max-w-7xl mx-auto flex gap-4 flex-wrap">
      <button onclick="showEmployeeTab('attendance')" id="emp-tab-attendance" class="tab-button active">Absensi</button>
      <button onclick="showEmployeeTab('roster')" id="emp-tab-roster" class="tab-button">Jadwal</button>
      <button onclick="showEmployeeTab('leave')" id="emp-tab-leave" class="tab-button">Izin</button>
    </div>
   </div>
   <div class="scrollable-content max-w-7xl mx-auto w-full">
    <div id="employee-content">
     <!-- TAB: Attendance -->
     <div id="employee-tab-attendance" class="tab-content">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
       <div id="clock-in-card" class="bg-white rounded-2xl p-8 card-shadow text-center"><div class="text-6xl mb-4">üü¢</div><h3 class="text-2xl font-bold mb-2">Clock In</h3><button onclick="showClockInModal()" class="w-full btn-success text-white font-bold py-4 rounded-xl text-lg">CLOCK IN</button></div>
       <div id="clock-out-card" class="bg-white rounded-2xl p-8 card-shadow text-center opacity-50 pointer-events-none"><div class="text-6xl mb-4">üî¥</div><h3 class="text-2xl font-bold mb-2">Clock Out</h3><button onclick="showClockOutModal()" class="w-full btn-danger text-white font-bold py-4 rounded-xl text-lg">CLOCK OUT</button></div>
      </div>
      
      <!-- INFO SESI GANTUNG (JIKA ADA) -->
      <div id="active-session-alert" class="hidden mb-6 bg-orange-100 border-l-4 border-orange-500 text-orange-700 p-4 rounded-xl flex items-center gap-3 shadow-sm">
          <div class="text-2xl">‚ö†Ô∏è</div>
          <div>
              <p class="font-bold">Status: Shift Belum Ditutup!</p>
              <p class="text-sm">Anda memiliki sesi absen yang belum Clock Out. Harap Clock Out terlebih dahulu.</p>
          </div>
      </div>

      <div class="bg-white rounded-2xl p-8 card-shadow"><h3 class="text-2xl font-bold mb-6">Riwayat</h3><div id="employee-attendance-list" class="space-y-4"></div></div>
     </div>
     <!-- TAB: Roster -->
     <div id="employee-tab-roster" class="tab-content hidden"><div class="bg-white rounded-2xl p-8 card-shadow"><h3 class="font-bold mb-4 text-xl">Jadwal Saya</h3><div id="employee-roster-list" class="grid grid-cols-1 md:grid-cols-3 gap-4"></div></div></div>
     <!-- TAB: Leave -->
     <div id="employee-tab-leave" class="tab-content hidden">
        <div class="bg-white rounded-2xl p-8 card-shadow mb-8">
            <h3 class="text-xl font-bold mb-4">Ajukan Izin</h3>
            <form onsubmit="submitLeaveRequest(event)" class="space-y-4">
                <select id="leave-type" class="w-full p-3 border rounded-xl"><option>Sakit</option><option>Izin</option><option>Cuti</option></select>
                <div class="flex gap-2"><input type="date" id="leave-start-date" class="w-full p-3 border rounded-xl"><input type="date" id="leave-end-date" class="w-full p-3 border rounded-xl"></div>
                <textarea id="leave-reason" class="w-full p-3 border rounded-xl" placeholder="Alasan"></textarea>
                <button type="submit" id="btn-submit-leave" class="w-full btn-success text-white font-bold py-3 rounded-xl">Kirim Pengajuan</button>
            </form>
        </div>
        <div id="employee-leave-list" class="space-y-4"></div>
     </div>
    </div>
   </div>
  </div>

  <!-- MODALS -->
  <div id="clock-in-modal" class="modal-overlay hidden">
   <div class="modal-content">
    <h2 class="text-3xl font-bold text-center mb-4">‚úÖ Clock In</h2>
    <div class="space-y-4">
     <div class="bg-green-50 p-4 rounded-xl"><h3 class="font-bold mb-2">üì∏ Selfie</h3><div class="camera-view mb-2"><video id="video-in" autoplay playsinline></video><canvas id="canvas-in" class="hidden"></canvas><img id="photo-in" class="captured-photo"></div><div class="flex gap-2"><button onclick="initCamera('in')" class="flex-1 bg-blue-600 text-white py-2 rounded">Buka Kamera</button><button onclick="takeSnapshot('in')" class="flex-1 bg-green-600 text-white py-2 rounded">Ambil Foto</button></div><input type="hidden" id="selfie-in-data"></div>
     <div class="bg-blue-50 p-4 rounded-xl"><h3 class="font-bold mb-2">üìç GPS</h3><div id="gps-status-in" class="hidden mb-2 p-2 text-center font-bold rounded"></div><button onclick="getLocation('in')" class="w-full bg-blue-600 text-white py-2 rounded">Cek Lokasi</button><input type="text" id="location-in" readonly class="w-full mt-2 p-2 border rounded"></div>
     
     <!-- CASH INPUT (HIDDEN UNLESS KASIR) -->
     <div id="cash-in-input-group" class="hidden bg-emerald-50 p-4 rounded-xl border border-emerald-200">
        <h3 class="font-bold mb-2 text-emerald-800">üí∞ Saldo Awal (Cash In)</h3>
        <input type="number" id="cash-in-amount" placeholder="Masukkan jumlah uang di kasir (Rp)" class="w-full p-3 border-2 border-emerald-300 rounded-xl text-lg font-bold">
     </div>

     <div class="bg-yellow-50 p-4 rounded-xl"><h3 class="font-bold mb-2">üìù Job Desk</h3><div id="job-desk-start" class="space-y-2"></div></div>
     <textarea id="notes-in" class="w-full p-3 border rounded" placeholder="Catatan..."></textarea>
     <div class="flex gap-2"><button onclick="clockIn(event)" id="btn-submit-clock-in" disabled class="flex-1 bg-gray-400 text-white py-3 rounded font-bold cursor-not-allowed">SUBMIT</button><button onclick="hideClockInModal()" class="flex-1 bg-gray-200 py-3 rounded font-bold">Batal</button></div>
    </div>
   </div>
  </div>

  <div id="clock-out-modal" class="modal-overlay hidden">
   <div class="modal-content">
    <h2 class="text-3xl font-bold text-center mb-4">‚õî Clock Out</h2>
    <div class="space-y-4">
     <div class="bg-red-50 p-4 rounded-xl"><h3 class="font-bold mb-2">üì∏ Selfie</h3><div class="camera-view mb-2"><video id="video-out" autoplay playsinline></video><canvas id="canvas-out" class="hidden"></canvas><img id="photo-out" class="captured-photo"></div><div class="flex gap-2"><button onclick="initCamera('out')" class="flex-1 bg-blue-600 text-white py-2 rounded">Buka Kamera</button><button onclick="takeSnapshot('out')" class="flex-1 bg-green-600 text-white py-2 rounded">Ambil Foto</button></div><input type="hidden" id="selfie-out-data"></div>
     
     <!-- CASH INPUT (HIDDEN UNLESS KASIR) -->
     <div id="cash-out-input-group" class="hidden bg-blue-50 p-4 rounded-xl border border-blue-200">
        <h3 class="font-bold mb-2 text-blue-800">üí∞ Saldo Akhir (Cash Out)</h3>
        <input type="number" id="cash-out-amount" placeholder="Total uang fisik saat pulang (Rp)" class="w-full p-3 border-2 border-blue-300 rounded-xl text-lg font-bold">
     </div>

     <!-- BAGIAN BARU: PENGAJUAN LEMBUR -->
     <div class="bg-orange-50 p-4 rounded-xl border border-orange-200">
         <h3 class="font-bold mb-2 text-orange-800">üî• Pengajuan Lembur</h3>
         <label class="flex items-center gap-2 mb-2 cursor-pointer">
             <input type="checkbox" id="check-overtime" onchange="toggleOvertimeInput(this)" class="w-5 h-5 accent-orange-600">
             <span class="text-sm font-bold">Saya melakukan Lembur hari ini</span>
         </label>
         <div id="overtime-inputs" class="hidden space-y-2 mt-2 pl-7 border-l-2 border-orange-200">
             <input type="number" id="overtime-duration" placeholder="Durasi (Jam)" class="w-full p-2 text-sm border rounded">
             <input type="text" id="overtime-reason" placeholder="Alasan (Wajib diisi)" class="w-full p-2 text-sm border rounded">
         </div>
     </div>

     <div class="bg-blue-50 p-4 rounded-xl"><h3 class="font-bold mb-2">üìç GPS</h3><div id="gps-status-out" class="hidden mb-2 p-2 text-center font-bold rounded"></div><button onclick="getLocation('out')" class="w-full bg-blue-600 text-white py-2 rounded">Cek Lokasi</button><input type="text" id="location-out" readonly class="w-full mt-2 p-2 border rounded"></div>
     <div class="bg-yellow-50 p-4 rounded-xl"><h3 class="font-bold mb-2">üìã Job Desk Akhir</h3><div id="job-desk-end" class="space-y-2"></div></div>
     <textarea id="notes-out" class="w-full p-3 border rounded" placeholder="Catatan..."></textarea>
     <div class="flex gap-2"><button onclick="clockOut(event)" id="btn-submit-clock-out" disabled class="flex-1 bg-gray-400 text-white py-3 rounded font-bold cursor-not-allowed">SUBMIT</button><button onclick="hideClockOutModal()" class="flex-1 bg-gray-200 py-3 rounded font-bold">Batal</button></div>
    </div>
   </div>
  </div>

  <!-- NEW MODAL: CORRECTION -->
  <div id="correction-modal" class="modal-overlay hidden">
    <div class="modal-content">
      <h2 class="text-2xl font-bold mb-4 border-b pb-2">‚úèÔ∏è Koreksi Absensi</h2>
      <form onsubmit="submitCorrection(event)" class="space-y-4">
        <input type="hidden" id="correct-emp-id">
        <div class="grid grid-cols-2 gap-4">
           <div><label class="block text-sm font-bold text-gray-700">Tanggal</label><input type="text" id="correct-date" readonly class="w-full p-2 bg-gray-100 border rounded"></div>
           <div><label class="block text-sm font-bold text-gray-700">Nama</label><input type="text" id="correct-name" readonly class="w-full p-2 bg-gray-100 border rounded"></div>
        </div>
        <div class="grid grid-cols-2 gap-4">
           <div><label class="block text-sm font-bold text-gray-700">Jam Masuk</label><input type="time" id="correct-in-time" class="w-full p-2 border rounded"></div>
           <div><label class="block text-sm font-bold text-gray-700">Jam Pulang</label><input type="time" id="correct-out-time" class="w-full p-2 border rounded"></div>
        </div>
        <div>
            <label class="block text-sm font-bold text-gray-700">Status Kehadiran</label>
            <select id="correct-status" class="w-full p-2 border rounded">
                <option value="Tepat Waktu">Tepat Waktu</option>
                <option value="Terlambat">Terlambat</option>
                <option value="Lupa Absen">Lupa Absen</option>
                <option value="Alpha">Alpha</option>
                <option value="Izin">Izin</option>
            </select>
        </div>
        <div class="bg-yellow-50 p-3 rounded text-sm text-gray-600">‚ö†Ô∏è Koreksi akan menimpa data yang ada secara permanen.</div>
        <div class="flex gap-2 pt-2">
            <button type="submit" id="btn-submit-correction" class="flex-1 btn-primary text-white font-bold py-2 rounded">Simpan Koreksi</button>
            <button type="button" onclick="document.getElementById('correction-modal').classList.add('hidden')" class="flex-1 bg-gray-300 font-bold py-2 rounded">Batal</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // --- KONFIGURASI ---
    const API_URL = "https://script.google.com/macros/s/AKfycby49EpPVo7oHgFLLjS421nnYdKt7EjGa6elDQ4jKfnXa_9xQdtr2ysXbuwDB_j7G2cQ/exec";
    const TARGET_LAT = -2.1717597105563065;
    const TARGET_LON = 115.40300588753108;
    const MAX_RADIUS_METERS = 200;

    // HELPERS DATE
    function getLocalISOString() {
        const offset = new Date().getTimezoneOffset() * 60000;
        const localISOTime = new Date(Date.now() - offset).toISOString().slice(0, 10);
        return localISOTime;
    }
    function getLocalTimeString() {
        const d = new Date();
        const h = ('0' + d.getHours()).slice(-2);
        const m = ('0' + d.getMinutes()).slice(-2);
        return `${h}:${m}`;
    }
    
    function formatRupiah(number) {
        return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR' }).format(number);
    }

    // === SHIFT TIME RULES (FOR TOLERANCE CALCULATION) ===
    // Format: HH:MM integer values. Tolerance is 15 mins.
    const SHIFT_RULES = {
        'Pagi': { start_h: 8, start_m: 0, end_h: 16, end_m: 0 },
        'Siang': { start_h: 16, start_m: 0, end_h: 23, end_m: 0 },
        'Malam': { start_h: 23, start_m: 0, end_h: 8, end_m: 0 } // Crosses day
    };

    function timeToMinutes(timeStr) {
        if(!timeStr) return 0;
        const [h, m] = timeStr.split(':').map(Number);
        return h * 60 + m;
    }

    // ROSTER VARS
    let currentRosterWeekOffset = 0;
    const SHIFT_TYPES = ['Off', 'Pagi', 'Siang', 'Malam'];
    const SHIFT_STYLES = { 'Off': 'bg-gray-200', 'Pagi': 'bg-yellow-200', 'Siang': 'bg-orange-200', 'Malam': 'bg-blue-200' };
    const SHIFT_TIMES = { 'Pagi': '08:00-15:59', 'Siang': '16:00-22:59', 'Malam': '23:00-07:59', 'Off': '-' };
    
    // DEFINISI URUTAN JABATAN (Prioritas Tampilan)
    const POSITION_RANK = { 
        'Supervisor': 1, 
        'Barista': 2, 
        'Bartender': 2, 
        'Kasir': 3, 
        'Chef': 4, 
        'Pelayan': 5,
        'Pramusaji': 5
    };

    let allData = [], currentUser = null; // Chat vars removed
    let currentJobDeskInCompleted = [], currentJobDeskOutCompleted = [];
    let mediaStream = null;

    const JOB_DESKS = {
      'Barista': { start: ['Cek & kalibrasi mesin espresso/grinder', 'Restock susu, biji kopi, & cup', 'Cek kebersihan station bar'], end: ['Bersihkan mesin (Backflush) & area bar', 'Cuci blender & peralatan seduh', 'Matikan mesin & catat stok sisa'] },
      'Bartender': { start: ['Cek & kalibrasi mesin espresso/grinder', 'Restock susu, biji kopi, & cup', 'Cek kebersihan station bar'], end: ['Bersihkan mesin (Backflush) & area bar', 'Cuci blender & peralatan seduh', 'Matikan mesin & catat stok sisa'] },
      'Kasir': { start: ['Hitung modal awal (Opening Float)', 'Cek kertas struk & mesin EDC', 'Login & cek koneksi POS'], end: ['Hitung uang fisik & closing POS', 'Pastikan kas balance (No selisih)', 'Rapikan area meja kasir'] },
      'Pelayan': { start: ['Cek kebersihan meja & kursi tamu', 'Siapkan cutlery (sendok/garpu) & tisu', 'Cek ketersediaan buku menu'], end: ['Clear-up semua meja kotor', 'Reset meja untuk besok', 'Pastikan area dining bersih total'] },
      'Pramusaji': { start: ['Cek kebersihan meja & kursi tamu', 'Siapkan cutlery (sendok/garpu) & tisu', 'Cek ketersediaan buku menu'], end: ['Clear-up semua meja kotor', 'Reset meja untuk besok', 'Pastikan area dining bersih total'] },
      'Chef': { start: ['Mise en place (Potong/siapkan bahan)', 'Cek kualitas bahan baku di kulkas', 'Cek stok'], end: ['Bersihkan kompor & area masak', 'Wrap & simpan bahan makanan (FIFO)', 'Matikan gas & listrik dapur'] },
      'Supervisor': { start: ['Briefing tim', 'Cek area', 'Cek target'], end: ['Laporan harian', 'Evaluasi shift', 'Kunci pintu'] },
      'Manager': { start: [], end: [] },
      'Security': { start: [], end: [] },
      'Admin': { start: [], end: [] }
    };

    // --- API HELPER ---
    async function postData(action, payload = {}) {
      try {
        const body = JSON.stringify({ action, ...payload });
        const res = await fetch(API_URL, { 
            method: 'POST', 
            redirect: 'follow', 
            headers: { "Content-Type": "text/plain;charset=utf-8" }, 
            body: body 
        });
        const data = await res.json();
        return data;
      } catch (e) {
        console.error("Fetch Error:", e);
        return { isOk: false, message: "Gagal terhubung ke server. Cek koneksi atau URL Script." };
      }
    }

    // --- INIT ---
    async function initApp() {
      updateDateTime();
      setInterval(updateDateTime, 1000);
      const res = await postData('getAll');
      if(res.isOk) {
          allData = res.data;
          // Set default date for manager filter
          const dateInput = document.getElementById('manager-att-date');
          const reportStart = document.getElementById('report-start');
          const reportEnd = document.getElementById('report-end');
          
          const today = getLocalISOString();
          if(dateInput && !dateInput.value) dateInput.value = today;
          
          // Default report: 1st of month to today
          if(reportStart && !reportStart.value) reportStart.value = today.slice(0, 8) + '01';
          if(reportEnd && !reportEnd.value) reportEnd.value = today;
      }
    }

    function updateDateTime() {
      const now = new Date();
      const time = getLocalTimeString();
      const date = now.toLocaleDateString('id-ID', {weekday:'long', day:'numeric', month:'long'});
      if(document.getElementById('current-time')) document.getElementById('current-time').innerText = time;
      if(document.getElementById('current-date-manager')) document.getElementById('current-date-manager').innerText = date;
      if(document.getElementById('current-date-employee')) document.getElementById('current-date-employee').innerText = date;
    }

    function showToast(msg, type='success') {
      const t = document.createElement('div');
      t.className = `toast ${type}`; t.innerText = msg;
      document.body.appendChild(t);
      setTimeout(()=>t.remove(), 3000);
    }

    // --- LOGIN ---
    async function handleLogin(e) {
      e.preventDefault();
      const u = document.getElementById('login-username').value;
      const p = document.getElementById('login-password').value;
      const btn = document.getElementById('btn-login');
      btn.innerText = "Memproses..."; btn.disabled = true;
      const res = await postData('login', { username: u, password: p });
      
      if (res.isOk) {
        currentUser = res.user;
        document.getElementById('login-screen').classList.add('hidden');
        await initApp(); 
        if (res.role === 'manager') {
           document.getElementById('manager-dashboard').classList.remove('hidden');
           updateManagerDashboard();
        } else {
           document.getElementById('employee-dashboard').classList.remove('hidden');
           document.getElementById('emp-dash-name').innerText = currentUser.name;
           updateEmployeeDashboard();
        }
        showToast("Login Berhasil!");
      } else {
        showToast(res.message, "error");
      }
      btn.innerText = "üöÄ LOGIN MASUK"; btn.disabled = false;
    }

    function logout() { location.reload(); }

    // --- MANAGER ---
    function showManagerTab(tab) {
      ['employees','attendance','roster','leave', 'report'].forEach(t => {
        document.getElementById('manager-tab-'+t).classList.add('hidden');
        document.getElementById('tab-'+t).classList.remove('active');
      });
      document.getElementById('manager-tab-'+tab).classList.remove('hidden');
      document.getElementById('tab-'+tab).classList.add('active');
      
      if(tab === 'roster') renderRosterGrid();
      if(tab === 'attendance') {
          renderManagerAttendance();
          renderShiftMonitor();
      }
    }

    function updateManagerDashboard() {
      renderEmployeeList();
      renderManagerAttendance();
      renderShiftMonitor();
      renderManagerLeaveList();
      const emps = allData.filter(d=>d.type==='employee');
      const atts = allData.filter(d=>d.type==='attendance' && d.attendance_date === getLocalISOString());
      document.getElementById('stat-total-employees').innerText = emps.length;
      document.getElementById('stat-present-today').innerText = atts.length;
    }

    // Employee CRUD
    function showEmployeeForm() { document.getElementById('employee-form').classList.remove('hidden'); document.getElementById('emp-id').value = 'EMP'+Date.now().toString().slice(-4); }
    function hideEmployeeForm() { document.getElementById('employee-form').classList.add('hidden'); }

    async function saveEmployee(e) {
      e.preventDefault();
      const btn = document.getElementById('btn-save-employee');
      btn.innerText = "Menyimpan..."; btn.disabled = true;
      const payload = {
        type: 'employee',
        employee_id: document.getElementById('emp-id').value,
        name: document.getElementById('emp-name').value,
        position: document.getElementById('emp-position').value,
        phone: document.getElementById('emp-phone').value,
        email: document.getElementById('emp-email').value,
        password: document.getElementById('emp-password').value
      };
      await postData('create', { payload });
      hideEmployeeForm();
      btn.innerText = "Simpan"; btn.disabled = false;
      showToast("Karyawan disimpan");
      await initApp(); updateManagerDashboard();
    }

    function renderEmployeeList() {
      const list = document.getElementById('employee-list');
      const emps = allData.filter(d=>d.type==='employee');
      list.innerHTML = emps.map(e => `
        <div class="bg-purple-50 p-4 rounded-xl border mb-2 flex justify-between items-center">
          <div><h4 class="font-bold">${e.name}</h4><p class="text-sm text-gray-600">${e.position} | ${e.employee_id}</p></div>
          <button onclick="deleteItem('${e.employee_id}', 'employee')" class="text-red-600 font-bold text-sm">Hapus</button>
        </div>
      `).join('');
    }

    async function deleteItem(id, type) {
      if(!confirm("Hapus data ini?")) return;
      await postData('delete', { payload: { type, employee_id: id } });
      await initApp(); updateManagerDashboard();
    }

    // NEW: LIVE SHIFT MONITOR FUNCTION
    function renderShiftMonitor() {
        const grid = document.getElementById('shift-monitor-grid');
        const dateDisplay = document.getElementById('monitor-date-display');
        const today = getLocalISOString();
        
        dateDisplay.innerText = new Date().toLocaleDateString('id-ID', { weekday: 'long', day: 'numeric', month: 'long' });

        // 1. Get Scheduled Roster
        const rosterToday = allData.filter(d => d.type === 'roster' && d.roster_date === today);
        
        // 2. Get Actual Attendance
        const attendanceToday = allData.filter(d => d.type === 'attendance' && d.attendance_date === today);
        
        // 3. Get All Employees (to map positions)
        const employees = allData.filter(d => d.type === 'employee');

        // 4. Grouping
        const groups = { 'Pagi': [], 'Siang': [], 'Malam': [], 'Extra': [] };

        // Process Scheduled
        rosterToday.forEach(r => {
            if(r.shift_type === 'Off') return;
            
            const att = attendanceToday.find(a => a.employee_id === r.employee_id);
            const emp = employees.find(e => e.employee_id === r.employee_id);
            
            groups[r.shift_type].push({
                name: r.name,
                position: emp ? emp.position : 'Staff',
                status: att ? 'Hadir' : 'Belum Hadir',
                time: att ? att.clock_in_time : '-',
                isExtra: false
            });
        });

        // Process Unscheduled (Extra)
        attendanceToday.forEach(a => {
            const isScheduled = rosterToday.some(r => r.employee_id === a.employee_id);
            if(!isScheduled) {
                const emp = employees.find(e => e.employee_id === a.employee_id);
                groups['Extra'].push({
                    name: a.name,
                    position: emp ? emp.position : 'Staff',
                    status: 'Hadir (Luar Jadwal)',
                    time: a.clock_in_time,
                    isExtra: true
                });
            }
        });

        // 5. Render HTML
        grid.innerHTML = '';
        const shiftColors = { 'Pagi': 'bg-yellow-500', 'Siang': 'bg-orange-500', 'Malam': 'bg-blue-800', 'Extra': 'bg-purple-600' };

        ['Pagi', 'Siang', 'Malam', 'Extra'].forEach(shift => {
            if(shift === 'Extra' && groups[shift].length === 0) return; // Hide extra if empty

            const items = groups[shift].map(p => `
                <div class="flex justify-between items-center p-2 mb-1 rounded bg-white bg-opacity-10 border border-white border-opacity-20">
                    <div>
                        <div class="font-bold text-sm">${p.name}</div>
                        <div class="text-xs opacity-75">${p.position}</div>
                    </div>
                    <div class="text-right">
                        <div class="text-xs font-bold ${p.status.includes('Hadir') ? 'text-green-300' : 'text-red-300'}">
                            ${p.status === 'Hadir' ? '‚úÖ Hadir' : (p.status.includes('Luar') ? '‚ö†Ô∏è Extra' : '‚ùå Belum')}
                        </div>
                        <div class="text-[10px]">${p.time}</div>
                    </div>
                </div>
            `).join('');

            grid.innerHTML += `
                <div class="rounded-xl overflow-hidden bg-black bg-opacity-20 backdrop-blur-sm border border-white border-opacity-10">
                    <div class="${shiftColors[shift]} p-3 font-bold text-center uppercase tracking-wider text-sm">
                        ${shift} (${groups[shift].length})
                    </div>
                    <div class="p-2 max-h-60 overflow-y-auto">
                        ${items || '<div class="text-center text-xs opacity-50 py-4">Tidak ada jadwal</div>'}
                    </div>
                </div>
            `;
        });
    }

    // REVISED: MANAGER ATTENDANCE WITH CORRECTION & OVERTIME BADGE & CASH REPORT
    function renderManagerAttendance() {
      const list = document.getElementById('manager-attendance-list');
      const filterDate = document.getElementById('manager-att-date').value || getLocalISOString();
      
      const atts = allData.filter(d => d.type==='attendance' && d.attendance_date === filterDate);
      
      if(atts.length===0) list.innerHTML = '<p class="text-center text-gray-400 py-4">Tidak ada data absensi pada tanggal ini.</p>';
      else list.innerHTML = atts.map(a => {
        // Determine status style
        const isLate = a.attendance_status && a.attendance_status.toLowerCase().includes('telat');
        const isEarly = a.attendance_status && a.attendance_status.toLowerCase().includes('cepat');
        const statusColor = (isLate || isEarly) ? 'bg-red-100 text-red-800' : 'bg-purple-100 text-purple-800';

        return `
        <div class="bg-white p-4 rounded-xl border mb-3 shadow-sm flex flex-col md:flex-row justify-between items-center gap-4">
          <div class="flex-1">
             <div class="flex items-center gap-2 mb-1">
                <span class="text-lg font-bold">${a.name}</span>
                <span class="text-xs ${statusColor} px-2 py-1 rounded font-bold">${a.attendance_status}</span>
                ${a.is_overtime ? `<span class="text-xs bg-orange-100 text-orange-800 px-2 py-1 rounded font-bold border border-orange-200">üî• Lembur ${a.overtime_duration} Jam</span>` : ''}
             </div>
             <div class="text-sm text-gray-600 grid grid-cols-2 gap-2">
                <div>üì• In: <span class="font-bold">${a.clock_in_time}</span></div>
                <div>üì§ Out: <span class="font-bold">${a.clock_out_time || '-'}</span></div>
             </div>
             
             <!-- CASH REPORT FOR MANAGER -->
             ${(a.cash_in_hand_start || a.cash_in_hand_end) ? `
                <div class="mt-2 p-2 bg-gray-50 rounded border border-gray-200 text-xs">
                    <div class="font-bold text-gray-700 mb-1">üí∞ Laporan Kasir</div>
                    <div class="grid grid-cols-2 gap-2">
                        <div class="text-green-700">Awal: <b>${formatRupiah(a.cash_in_hand_start || 0)}</b></div>
                        <div class="text-blue-700">Akhir: <b>${formatRupiah(a.cash_in_hand_end || 0)}</b></div>
                    </div>
                </div>
             ` : ''}

             ${a.is_overtime ? `<div class="text-xs text-orange-600 mt-1 italic">"Alasan: ${a.overtime_reason}"</div>` : ''}
             <div class="text-xs text-gray-400 mt-1">${a.notes_in || ''}</div>
          </div>
          <button onclick="openCorrectionModal('${a.employee_id}', '${a.attendance_date}')" class="bg-yellow-100 hover:bg-yellow-200 text-yellow-800 px-4 py-2 rounded-lg font-bold text-sm flex items-center gap-2">
            ‚úèÔ∏è Koreksi
          </button>
        </div>
      `;
      }).join('');
    }

    function renderManagerLeaveList() {
      const list = document.getElementById('manager-leave-list');
      const leaves = allData.filter(d=>d.type==='leave');
      list.innerHTML = leaves.map(l => `
        <div class="bg-white p-4 border rounded-xl mb-2">
          <div class="flex justify-between font-bold"><span>${l.name}</span><span class="text-${l.status==='Pending'?'yellow':'green'}-600">${l.status}</span></div>
          <p class="text-sm">${l.leave_type}: ${l.start_date}</p>
          <p class="text-xs text-gray-500 mb-2">${l.reason}</p>
          ${l.status === 'Pending' ? `
            <div class="flex gap-2">
              <button onclick="approveLeave('${l.employee_id}', '${l.start_date}', 'Disetujui')" class="bg-green-500 text-white px-3 py-1 rounded text-xs">Terima</button>
              <button onclick="approveLeave('${l.employee_id}', '${l.start_date}', 'Ditolak')" class="bg-red-500 text-white px-3 py-1 rounded text-xs">Tolak</button>
            </div>
          ` : ''}
        </div>
      `).join('');
    }

    async function approveLeave(id, date, status) {
      const payload = { type: 'leave', employee_id: id, start_date: date, status: status, approved_by: 'Manager', approved_at: new Date().toISOString() };
      await postData('update', { payload });
      await initApp(); updateManagerDashboard();
    }

    // REPORTING LOGIC
    function generateReport() {
        const start = document.getElementById('report-start').value;
        const end = document.getElementById('report-end').value;
        const body = document.getElementById('report-table-body');

        if(!start || !end) return alert("Pilih tanggal awal dan akhir!");

        // 1. Filter Data
        const atts = allData.filter(d => 
            d.type === 'attendance' && 
            d.attendance_date >= start && 
            d.attendance_date <= end
        );

        // 2. Aggregate per Employee
        const report = {};
        
        atts.forEach(a => {
            if(!report[a.employee_id]) {
                report[a.employee_id] = { 
                    name: a.name, 
                    position: a.position, 
                    count: 0, 
                    workMinutes: 0, 
                    overtimeHours: 0 
                };
            }
            
            // Count Attendance
            report[a.employee_id].count++;
            
            // Sum Work Duration (If Clock Out exists)
            if(a.clock_in_time && a.clock_out_time) {
                const inMins = timeToMinutes(a.clock_in_time);
                let outMins = timeToMinutes(a.clock_out_time);
                
                // Handle Night Shift Crossing Midnight (e.g., In 23:00, Out 06:00)
                if(outMins < inMins) outMins += (24 * 60);
                
                report[a.employee_id].workMinutes += (outMins - inMins);
            }

            // Sum Overtime
            if(a.is_overtime && a.overtime_duration) {
                report[a.employee_id].overtimeHours += parseFloat(a.overtime_duration);
            }
        });

        // 3. Render Table
        if(Object.keys(report).length === 0) {
            body.innerHTML = '<tr><td colspan="5" class="p-8 text-center text-gray-400">Tidak ada data pada periode ini.</td></tr>';
            return;
        }

        body.innerHTML = Object.values(report).map(r => {
            const totalHours = (r.workMinutes / 60).toFixed(1);
            return `
            <tr class="border-b hover:bg-gray-50">
                <td class="p-4 font-bold text-gray-800">${r.name}</td>
                <td class="p-4 text-sm">${r.position}</td>
                <td class="p-4 text-center font-bold bg-blue-50 text-blue-800 rounded-lg">${r.count} Shift</td>
                <td class="p-4 text-center font-bold text-gray-700">${totalHours} Jam</td>
                <td class="p-4 text-center font-bold text-orange-600">${r.overtimeHours > 0 ? r.overtimeHours + ' Jam' : '-'}</td>
            </tr>
            `;
        }).join('');
    }

    // CLOCK IN/OUT (FIXED LOGIC FOR NIGHT SHIFT + CASH INPUT FOR KASIR + STATUS TOLERANCE)
    
    function showClockInModal() { 
        document.getElementById('clock-in-modal').classList.remove('hidden'); 
        initCamera('in');
        const list = JOB_DESKS[currentUser.position]?.start || [];
        document.getElementById('job-desk-start').innerHTML = list.map((t, i) => `<label class="flex gap-2 p-2 border rounded"><input type="checkbox" onchange="updateJobIn(${i},this.checked)"> ${t}</label>`).join('');
        currentJobDeskInCompleted = [];

        // Show Cash Input if Kasir
        const cashInput = document.getElementById('cash-in-input-group');
        if (currentUser.position === 'Kasir') {
            cashInput.classList.remove('hidden');
            document.getElementById('cash-in-amount').value = ''; // Reset value
        } else {
            cashInput.classList.add('hidden');
        }
    }

    function showClockOutModal() { 
        document.getElementById('clock-out-modal').classList.remove('hidden'); 
        initCamera('out'); 
        // Reset Overtime Form
        document.getElementById('check-overtime').checked = false;
        document.getElementById('overtime-inputs').classList.add('hidden');
        document.getElementById('overtime-duration').value = '';
        document.getElementById('overtime-reason').value = '';
        
        const list = JOB_DESKS[currentUser.position]?.end || [];
        document.getElementById('job-desk-end').innerHTML = list.map((t, i) => `<label class="flex gap-2 p-2 border rounded"><input type="checkbox" onchange="updateJobOut(${i},this.checked)"> ${t}</label>`).join('');
        currentJobDeskOutCompleted = [];

        // Show Cash Input if Kasir
        const cashInput = document.getElementById('cash-out-input-group');
        if (currentUser.position === 'Kasir') {
            cashInput.classList.remove('hidden');
            document.getElementById('cash-out-amount').value = ''; // Reset value
        } else {
            cashInput.classList.add('hidden');
        }
    }
    
    function toggleOvertimeInput(checkbox) {
        const inputs = document.getElementById('overtime-inputs');
        if(checkbox.checked) {
            inputs.classList.remove('hidden');
        } else {
            inputs.classList.add('hidden');
        }
    }

    function hideClockInModal() { document.getElementById('clock-in-modal').classList.add('hidden'); stopCamera(); }
    function hideClockOutModal() { document.getElementById('clock-out-modal').classList.add('hidden'); stopCamera(); }

    function updateJobIn(i, c) { c ? currentJobDeskInCompleted.push(i) : currentJobDeskInCompleted.splice(currentJobDeskInCompleted.indexOf(i), 1); }
    function updateJobOut(i, c) { c ? currentJobDeskOutCompleted.push(i) : currentJobDeskOutCompleted.splice(currentJobDeskOutCompleted.indexOf(i), 1); }

    // === NEW LOGIC: FLEXIBLE SHIFT DETECTION ===
    function detectShift(hour) {
        if (hour >= 6 && hour < 14) return 'Pagi';
        if (hour >= 14 && hour < 22) return 'Siang';
        return 'Malam'; // 22:00 - 06:00
    }

    function calculateLateStatus(shift, clockInTimeStr) {
        if (!clockInTimeStr) return "Tidak Diketahui";
        const rule = SHIFT_RULES[shift];
        if (!rule) return "Tepat Waktu"; // Fallback

        const [hIn, mIn] = clockInTimeStr.split(':').map(Number);
        let inMins = hIn * 60 + mIn;
        
        let targetMins = rule.start_h * 60 + rule.start_m;
        // Tolerance is 15 mins
        let toleranceLimit = targetMins + 15;

        // Special Case: Shift Malam (Start 23:00)
        // If employee enters at 00:10, logic needs adjustment.
        // Assume shift Malam starts previous day if clocking in late night or very early morning.
        if (shift === 'Malam') {
             // If In time is early morning (e.g., 00:05), treat as next day > add 24h to target? No, treat input as linear time.
             // Simpler: Convert "Late Night" times to > 24h scale if needed, OR just compare normally.
             // Start 23:00. Late limit 23:15.
             // If In is 00:30 (next day), that's DEFINITELY late.
             // Logic: If hour < 12 (early morning), add 24h to time for comparison.
             if (hIn < 12) inMins += 24 * 60; 
        }

        if (inMins > toleranceLimit) {
            const lateMins = inMins - targetMins;
            return `Terlambat (${lateMins} mnt)`;
        }
        return "Tepat Waktu";
    }

    function calculateEarlyLeaveStatus(shift, clockOutTimeStr, existingStatus) {
        if (!clockOutTimeStr) return existingStatus;
        const rule = SHIFT_RULES[shift];
        if (!rule) return existingStatus;

        const [hOut, mOut] = clockOutTimeStr.split(':').map(Number);
        let outMins = hOut * 60 + mOut;
        
        let targetEndMins = rule.end_h * 60 + rule.end_m;
        
        // Shift Malam ends at 08:00 (next day). 
        // Logic: If Shift is Malam, target is 8:00 (which is just 480 mins).
        // But employee started previous day. 
        // Just use standard linear day time for comparison if we assume they clock out in the morning.
        // If they clock out at 23:00 previous day? That's super early leave.
        // Assume Out time is on the correct "day side".
        // If Shift is Malam (Ends 8:00) and Out is > 12:00 (e.g. 23:30), treat as Previous Day -> Subtract 24h? No.
        // Easiest: If shift is Malam and Out > 15:00, treat as 'previous day' relative to 8:00? 
        // Standard: Shift Malam ends 08:00. Early leave if < 07:45.
        // If someone leaves at 07:00 -> Early.
        
        // Tolerance: 15 mins BEFORE end.
        let toleranceLimit = targetEndMins - 15; 
        
        // Special handling for Malam crossing midnight logic if output is e.g. 06:00
        if (shift === 'Malam') {
             // Target 8:00. Limit 7:45.
             // If out is 07:00 -> 420 < 465 -> Early. Correct.
        } else if (shift === 'Siang') {
             // Target 23:00. Limit 22:45.
             // If out is 00:30 (next day), treat as > 24h.
             if (hOut < 12) outMins += 24 * 60;
        }

        if (outMins < toleranceLimit) {
            return `${existingStatus} & Pulang Cepat`;
        }
        return existingStatus;
    }

    async function clockIn(e) {
      e.preventDefault();
      const btn = document.getElementById('btn-submit-clock-in');
      
      // Validasi Uang Kasir
      let cashStart = '';
      if (currentUser.position === 'Kasir') {
          cashStart = document.getElementById('cash-in-amount').value;
          if (!cashStart) {
              alert("Wajib mengisi jumlah uang di brangkas!");
              return;
          }
      }

      btn.disabled = true; btn.innerText = "Memproses...";
      
      const currentTimeStr = getLocalTimeString();
      const currentHour = parseInt(currentTimeStr.split(':')[0]);
      
      // AUTO DETECT SHIFT & STATUS
      const detectedShift = detectShift(currentHour);
      
      // NEW: Calculate precise Late Status
      const status = calculateLateStatus(detectedShift, currentTimeStr);

      const payload = {
        type: 'attendance',
        employee_id: currentUser.employee_id, name: currentUser.name, position: currentUser.position,
        attendance_date: getLocalISOString(),
        clock_in_time: currentTimeStr,
        attendance_status: status, 
        shift_type: detectedShift, // Store detected shift for Clock Out reference
        location_in: document.getElementById('location-in').value,
        selfie_in_url: document.getElementById('selfie-in-data').value,
        notes_in: document.getElementById('notes-in').value,
        job_desk_in: currentJobDeskInCompleted.length + ' tugas selesai',
        cash_in_hand_start: cashStart 
      };
      
      await postData('create', { payload });
      hideClockInModal();
      await initApp(); updateEmployeeDashboard();
      showToast("Berhasil Clock In (Shift " + detectedShift + ")");
    }

    async function clockOut(e) {
      e.preventDefault();
      const btn = document.getElementById('btn-submit-clock-out');
      
      // Validasi Input Lembur & Cash
      const isOvertime = document.getElementById('check-overtime').checked;
      const otDuration = document.getElementById('overtime-duration').value;
      const otReason = document.getElementById('overtime-reason').value;

      if(isOvertime) {
          if(!otDuration || !otReason) {
              alert("Mohon isi Durasi dan Alasan Lembur!");
              return;
          }
      }

      let cashEnd = '';
      if (currentUser.position === 'Kasir') {
          cashEnd = document.getElementById('cash-out-amount').value;
          if (!cashEnd) {
              alert("Wajib mengisi jumlah uang akhir di brangkas!");
              return;
          }
      }

      btn.disabled = true; btn.innerText = "Memproses...";

      // FIX: Cari tanggal masuk yang asli
      const myPendingAttendance = allData.find(d => 
          d.type === 'attendance' && 
          d.employee_id === currentUser.employee_id && 
          (!d.clock_out_time || d.clock_out_time === '')
      );

      const targetDate = myPendingAttendance ? myPendingAttendance.attendance_date : getLocalISOString();
      
      // NEW: Retrieve shift info to calculate Early Leave
      const shift = myPendingAttendance ? (myPendingAttendance.shift_type || 'Pagi') : 'Pagi';
      const currentStatus = myPendingAttendance ? myPendingAttendance.attendance_status : 'Tepat Waktu';
      const outTime = getLocalTimeString();
      
      // Calculate Final Status (Append Early Leave if needed)
      const finalStatus = calculateEarlyLeaveStatus(shift, outTime, currentStatus);

      const payload = {
        type: 'attendance',
        employee_id: currentUser.employee_id,
        attendance_date: targetDate, 
        clock_out_time: outTime,
        attendance_status: finalStatus, // Update status with early leave info
        location_out: document.getElementById('location-out').value,
        selfie_out_url: document.getElementById('selfie-out-data').value,
        notes_out: document.getElementById('notes-out').value,
        job_desk_out: currentJobDeskOutCompleted.length + ' tugas selesai',
        is_overtime: isOvertime,
        overtime_duration: isOvertime ? otDuration : '',
        overtime_reason: isOvertime ? otReason : '',
        cash_in_hand_end: cashEnd 
      };
      
      await postData('update', { payload });
      hideClockOutModal();
      await initApp(); updateEmployeeDashboard();
      showToast("Berhasil Clock Out");
    }

    // CAMERA & GPS
    async function initCamera(type) {
        try {
            if(mediaStream) mediaStream.getTracks().forEach(t=>t.stop());
            mediaStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } });
            document.getElementById('video-'+type).srcObject = mediaStream;
            document.getElementById('video-'+type).classList.remove('hidden');
            document.getElementById('photo-'+type).classList.add('hidden');
        } catch(e){ showToast("Kamera Error","error"); }
    }
    function takeSnapshot(type) {
        const v = document.getElementById('video-'+type);
        const c = document.getElementById('canvas-'+type);
        c.width = v.videoWidth; c.height = v.videoHeight;
        c.getContext('2d').drawImage(v,0,0);
        const data = c.toDataURL('image/jpeg');
        document.getElementById('selfie-'+type+'-data').value = data;
        document.getElementById('photo-'+type).src = data;
        document.getElementById('photo-'+type).classList.remove('hidden');
        v.classList.add('hidden');
    }
    function stopCamera() { if(mediaStream) mediaStream.getTracks().forEach(t=>t.stop()); }

    function getLocation(type) {
        const status = document.getElementById('gps-status-'+type);
        const btn = document.getElementById('btn-submit-clock-'+type);
        status.classList.remove('hidden'); status.innerText = "Mendeteksi...";
        
        navigator.geolocation.getCurrentPosition(pos => {
            const dist = getDist(pos.coords.latitude, pos.coords.longitude, TARGET_LAT, TARGET_LON);
            document.getElementById('location-'+type).value = `${pos.coords.latitude},${pos.coords.longitude} (${Math.round(dist)}m)`;
            
            if (dist <= MAX_RADIUS_METERS) {
                status.innerText = "‚úÖ Lokasi Valid"; status.className = "mb-2 p-2 bg-green-100 text-green-800 rounded text-center font-bold";
                btn.disabled = false; btn.classList.remove('bg-gray-400', 'cursor-not-allowed');
                btn.classList.add(type==='in'?'bg-green-600':'bg-red-600');
                btn.innerText = "SUBMIT";
            } else {
                status.innerText = `‚ùå Diluar Radius (${Math.round(dist)}m)`; status.className = "mb-2 p-2 bg-red-100 text-red-800 rounded text-center font-bold";
                btn.disabled = true;
            }
        });
    }
    
    function getDist(lat1, lon1, lat2, lon2) {
        const R = 6371e3; 
        const œÜ1 = lat1 * Math.PI/180, œÜ2 = lat2 * Math.PI/180;
        const ŒîœÜ = (lat2-lat1) * Math.PI/180, ŒîŒª = (lon2-lon1) * Math.PI/180;
        const a = Math.sin(ŒîœÜ/2)**2 + Math.cos(œÜ1)*Math.cos(œÜ2) * Math.sin(ŒîŒª/2)**2;
        return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }

    // UPDATED: LOGIC DASHBOARD KARYAWAN UNTUK SHIFT LINTAS HARI
    function updateEmployeeDashboard() {
      const myAtt = allData.filter(d => d.type === 'attendance' && d.employee_id === currentUser.employee_id);
      
      // 1. Cari Sesi Aktif (Gantung) - Prioritas Utama
      // Cari data yang clock_out-nya masih kosong (undefined atau string kosong)
      const openSession = myAtt.find(d => !d.clock_out_time || d.clock_out_time === '');
      
      const inCard = document.getElementById('clock-in-card');
      const outCard = document.getElementById('clock-out-card');
      const alertBox = document.getElementById('active-session-alert');
      
      // Reset classes
      inCard.classList.remove('opacity-50','pointer-events-none');
      outCard.classList.remove('opacity-50','pointer-events-none');
      alertBox.classList.add('hidden');

      if (openSession) {
         // Ada sesi gantung (baik hari ini atau kemarin) -> WAJIB CLOCK OUT DULU
         inCard.classList.add('opacity-50','pointer-events-none'); // Matikan Clock In
         outCard.classList.remove('opacity-50','pointer-events-none'); // Nyalakan Clock Out
         
         // Tampilkan Alert Warning
         alertBox.classList.remove('hidden');
      } else {
         // Tidak ada sesi gantung (Semua sudah closed atau belum absen)
         // Logika lama: Satu hari satu absen.
         const today = getLocalISOString();
         const todayAtt = myAtt.find(a => a.attendance_date === today);
         
         if (todayAtt) {
             // Sudah absen hari ini dan sudah pulang -> Matikan semua (Selesai tugas hari ini)
             inCard.classList.add('opacity-50','pointer-events-none');
             outCard.classList.add('opacity-50','pointer-events-none');
         } else {
             // Belum absen hari ini -> Nyalakan Clock In
             inCard.classList.remove('opacity-50','pointer-events-none');
             outCard.classList.add('opacity-50','pointer-events-none');
         }
      }
      
      // Render List (Urutkan dari yang terbaru: kombinasi tanggal + jam)
      myAtt.sort((a, b) => {
          const timeA = a.attendance_date + 'T' + (a.clock_in_time || '00:00');
          const timeB = b.attendance_date + 'T' + (b.clock_in_time || '00:00');
          return new Date(timeB) - new Date(timeA);
      });
      
      document.getElementById('employee-attendance-list').innerHTML = myAtt.map(a => {
        const isLate = a.attendance_status && a.attendance_status.toLowerCase().includes('telat');
        const isEarly = a.attendance_status && a.attendance_status.toLowerCase().includes('cepat');
        const color = (isLate || isEarly) ? 'text-red-600' : 'text-green-600';
        
        return `
        <div class="bg-white p-4 border rounded-xl mb-2 shadow-sm">
           <div class="flex justify-between font-bold"><span>${a.attendance_date}</span><span class="${color} text-sm">${a.attendance_status || '-'}</span></div>
           <div class="text-sm mt-1">In: ${a.clock_in_time} | Out: ${a.clock_out_time || '-'}</div>
        </div>
      `;
      }).join('');
    }

    // EMPLOYEE LOGIC
    function showEmployeeTab(tab) {
      ['attendance','roster','leave'].forEach(t => {
        document.getElementById('employee-tab-'+t).classList.add('hidden');
        document.getElementById('emp-tab-'+t).classList.remove('active');
      });
      document.getElementById('employee-tab-'+tab).classList.remove('hidden');
      document.getElementById('emp-tab-'+tab).classList.add('active');
      if(tab==='roster') renderEmployeeRoster();
      if(tab==='leave') renderEmployeeLeaveList();
    }

    function renderEmployeeRoster() {
      const rosters = allData.filter(d => d.type === 'roster' && d.employee_id === currentUser.employee_id);
      document.getElementById('employee-roster-list').innerHTML = rosters.map(r => `
        <div class="bg-purple-50 p-4 rounded-xl text-center border border-purple-100"><div class="font-bold text-lg">${r.roster_date}</div><div class="text-purple-600 font-bold">${r.shift_type}</div></div>
      `).join('');
    }

    async function submitLeaveRequest(e) {
      e.preventDefault();
      const btn = document.getElementById('btn-submit-leave');
      btn.disabled = true; btn.innerText = "Mengirim...";
      const payload = {
        type: 'leave', employee_id: currentUser.employee_id, name: currentUser.name, position: currentUser.position,
        leave_type: document.getElementById('leave-type').value,
        start_date: document.getElementById('leave-start-date').value,
        end_date: document.getElementById('leave-end-date').value,
        reason: document.getElementById('leave-reason').value,
        status: 'Pending'
      };
      await postData('create', { payload });
      showToast("Izin diajukan");
      btn.disabled = false; btn.innerText = "Kirim Pengajuan";
      await initApp(); renderEmployeeLeaveList();
    }

    function renderEmployeeLeaveList() {
      const leaves = allData.filter(d => d.type === 'leave' && d.employee_id === currentUser.employee_id);
      document.getElementById('employee-leave-list').innerHTML = leaves.map(l => `
        <div class="bg-white p-4 border rounded-xl mb-2"><p class="font-bold">${l.leave_type} <span class="text-gray-500 text-xs">(${l.status})</span></p><p class="text-xs">${l.start_date} s/d ${l.end_date}</p></div>
      `).join('');
    }

    // NEW: CORRECTION LOGIC
    function openCorrectionModal(empId, date) {
        const record = allData.find(d => d.type === 'attendance' && d.employee_id === empId && d.attendance_date === date);
        if(!record) return showToast("Data tidak ditemukan", "error");

        document.getElementById('correct-emp-id').value = empId;
        document.getElementById('correct-date').value = date;
        document.getElementById('correct-name').value = record.name;
        document.getElementById('correct-in-time').value = record.clock_in_time || '';
        document.getElementById('correct-out-time').value = record.clock_out_time || '';
        document.getElementById('correct-status').value = record.attendance_status || 'Tepat Waktu';

        document.getElementById('correction-modal').classList.remove('hidden');
    }

    async function submitCorrection(e) {
        e.preventDefault();
        const btn = document.getElementById('btn-submit-correction');
        btn.disabled = true; btn.innerText = "Menyimpan...";

        const payload = {
            type: 'attendance',
            employee_id: document.getElementById('correct-emp-id').value,
            attendance_date: document.getElementById('correct-date').value,
            clock_in_time: document.getElementById('correct-in-time').value,
            clock_out_time: document.getElementById('correct-out-time').value,
            attendance_status: document.getElementById('correct-status').value,
            // Keep existing fields safe if not edited
            notes_in: "Dikoreksi Manager",
        };

        await postData('update', { payload });
        document.getElementById('correction-modal').classList.add('hidden');
        showToast("Absensi Berhasil Dikoreksi");
        btn.disabled = false; btn.innerText = "Simpan Koreksi";
        
        await initApp();
        renderManagerAttendance();
    }

    // ROSTER GRID
    function changeRosterWeek(offset) { currentRosterWeekOffset += offset; renderRosterGrid(); }

    function renderRosterGrid() {
      const headerRow = document.getElementById('roster-header-row');
      const body = document.getElementById('roster-grid-body');
      
      // 1. Ambil Data & SORTIR Berdasarkan Jabatan
      let emps = allData.filter(d => d.type === 'employee');
      
      emps.sort((a, b) => {
          // Ambil ranking, jika tidak ada set ke 99 (paling bawah)
          const rankA = POSITION_RANK[a.position] || 99;
          const rankB = POSITION_RANK[b.position] || 99;
          
          // Sort Utama: Berdasarkan Ranking Jabatan
          if (rankA !== rankB) return rankA - rankB;
          
          // Sort Kedua: Berdasarkan Nama (Abjad) jika jabatan sama
          return a.name.localeCompare(b.name);
      });

      const rosters = allData.filter(d => d.type === 'roster');

      const today = new Date();
      const dayOfWeek = today.getDay(); 
      const startDiff = today.getDate() - dayOfWeek + (dayOfWeek == 0 ? -6 : 1) + (currentRosterWeekOffset * 7);
      
      const weekDates = [];
      headerRow.innerHTML = '<th class="p-4 bg-gray-50">Karyawan</th>';
      
      for (let i=0; i<7; i++) {
        const d = new Date(today);
        d.setDate(startDiff + i);
        const dateStr = d.toLocaleDateString('id-ID', {weekday:'short', day:'numeric'});
        const offset = d.getTimezoneOffset() * 60000;
        const isoDate = new Date(d.getTime() - offset).toISOString().slice(0,10);
        
        weekDates.push({ display: dateStr, iso: isoDate });
        headerRow.innerHTML += `<th class="p-2 text-xs text-center">${dateStr}</th>`;
      }

      body.innerHTML = emps.map(e => {
        // Tampilkan Nama DAN Jabatan agar grouping terlihat jelas
        let cells = `
            <td class="p-2 border-r bg-gray-50">
                <div class="font-bold text-xs text-gray-800">${e.name}</div>
                <div class="text-[10px] text-gray-500 uppercase tracking-wider">${e.position}</div>
            </td>`;
            
        weekDates.forEach(dt => {
          const shift = rosters.find(r => r.employee_id === e.employee_id && r.roster_date === dt.iso);
          const shiftType = shift ? shift.shift_type : 'Off';
          const style = SHIFT_STYLES[shiftType];
          cells += `<td onclick="cycleShift('${e.employee_id}', '${e.name}', '${dt.iso}', '${shiftType}')"><div class="roster-cell ${style} text-center">${shiftType === 'Off' ? '‚ùå' : shiftType}</div></td>`;
        });
        return `<tr class="hover:bg-gray-50 transition">${cells}</tr>`;
      }).join('');
      
      document.getElementById('roster-period-label').innerText = `${weekDates[0].display} - ${weekDates[6].display}`;
    }

    async function cycleShift(empId, empName, date, currentType) {
      const currentIndex = SHIFT_TYPES.indexOf(currentType);
      const nextIndex = (currentIndex + 1) % SHIFT_TYPES.length;
      const nextType = SHIFT_TYPES[nextIndex];
      const nextTime = SHIFT_TIMES[nextType];
      
      const payload = {
        type: 'roster', employee_id: empId, name: empName, roster_date: date,
        shift_type: nextType, shift_start: nextTime.split('-')[0] || '', shift_end: nextTime.split('-')[1] || ''
      };
      
      await postData('create', { payload });
      allData = allData.filter(d => !(d.type === 'roster' && d.employee_id === empId && d.roster_date === date));
      allData.push(payload);
      renderRosterGrid();
    }

    document.addEventListener('DOMContentLoaded', initApp);
  </script>
 </body>
</html>
