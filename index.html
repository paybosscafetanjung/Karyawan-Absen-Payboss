<!doctype html>
<html lang="id">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PayBoss Cafe - Sistem Absensi</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 0; height: 100%; }
    html { height: 100%; }
    .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .gradient-success { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); }
    .card-shadow { box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
    .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); transition: transform 0.2s; }
    .btn-primary:hover { transform: scale(1.05); }
    .btn-success { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); }
    .btn-danger { background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%); }
    .toast { position: fixed; top: 20px; right: 20px; padding: 16px 24px; background: white; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); z-index: 10000; animation: slideIn 0.3s ease-out; border-left: 4px solid; max-width: 400px; }
    .toast.success { border-left-color: #10b981; }
    .toast.error { border-left-color: #ef4444; }
    @keyframes slideIn { from { transform: translateX(400px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); display: flex; align-items: center; justify-content: center; z-index: 9999; padding: 20px; overflow-y: auto; }
    .modal-content { background: white; border-radius: 20px; padding: 30px; max-width: 700px; width: 100%; max-height: 90%; overflow-y: auto; }
    .page-container { min-height: 100%; display: flex; flex-direction: column; }
    .scrollable-content { flex: 1; overflow-y: auto; padding: 24px; }
    .tab-button { padding: 12px 24px; font-weight: bold; border-radius: 12px; transition: all 0.3s; cursor: pointer; }
    .tab-button.active { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
    .tab-button:not(.active) { background: white; color: #6b7280; }
    .tab-button:not(.active):hover { background: #f3f4f6; }
    
    /* ROSTER GRID STYLES */
    .roster-table th, .roster-table td { border: 1px solid #e5e7eb; padding: 8px; text-align: center; min-width: 80px; }
    .roster-table th:first-child, .roster-table td:first-child { position: sticky; left: 0; background: white; z-index: 10; border-right: 2px solid #e5e7eb; min-width: 120px; text-align: left; }
    .roster-cell { cursor: pointer; transition: all 0.2s; border-radius: 8px; padding: 8px 4px; font-size: 12px; font-weight: bold; }
    .roster-cell:hover { transform: scale(1.05); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .shift-pagi { background-color: #FEF3C7; color: #92400E; border: 1px solid #F59E0B; }
    .shift-siang { background-color: #FFEDD5; color: #9A3412; border: 1px solid #EA580C; }
    .shift-malam { background-color: #DBEAFE; color: #1E3A8A; border: 1px solid #2563EB; }
    .shift-off { background-color: #F3F4F6; color: #6B7280; border: 1px solid #D1D5DB; }

    /* Camera & GPS */
    .camera-view { width: 100%; border-radius: 12px; background: #000; overflow: hidden; position: relative; min-height: 240px; }
    video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
    .captured-photo { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: 10; display: none; }
    .hidden { display: none; }
  </style>
 </head>
 <body class="bg-gray-100">
  <!-- LOGIN SCREEN -->
  <div id="login-screen" class="min-h-full gradient-bg flex items-center justify-center p-6">
   <div class="bg-white rounded-3xl p-10 max-w-md w-full card-shadow text-center">
    <div class="text-6xl mb-4">‚òï</div><h1 class="text-4xl font-bold text-gray-800 mb-2">PayBoss Cafe</h1><p class="text-gray-500 mb-8">Sistem Absensi Terintegrasi</p>
    <form onsubmit="handleLogin(event)" class="space-y-4 text-left">
      <div><label class="block text-sm font-bold text-gray-700 mb-1">Username / ID</label><input type="text" id="login-username" required class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl" placeholder="manager / EMP..."></div>
      <div><label class="block text-sm font-bold text-gray-700 mb-1">Password</label><input type="password" id="login-password" required class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl" placeholder="******"></div>
      <button type="submit" id="btn-login" class="w-full btn-primary text-white font-bold py-3 rounded-xl shadow-lg hover:opacity-90 transition">üöÄ LOGIN MASUK</button>
    </form>
    <p class="text-xs text-gray-400 mt-6">Manager: manager / manager123</p>
   </div>
  </div>

  <!-- MANAGER DASHBOARD -->
  <div id="manager-dashboard" class="hidden page-container">
   <header class="bg-white shadow-lg border-b-4 border-purple-600 p-6">
    <div class="flex justify-between items-center max-w-7xl mx-auto">
     <div><h1 class="text-3xl font-bold text-gray-800">Dashboard Manager</h1><p class="text-gray-600">PayBoss Cafe</p></div>
     <button onclick="logout()" class="px-6 py-2 bg-red-600 text-white font-bold rounded-lg">Logout</button>
    </div>
   </header>
   <div class="bg-white shadow-md p-4">
    <div class="max-w-7xl mx-auto flex gap-4 flex-wrap">
      <button onclick="showManagerTab('employees')" id="tab-employees" class="tab-button active">üë• Karyawan</button> 
      <button onclick="showManagerTab('attendance')" id="tab-attendance" class="tab-button">üìä Absensi</button>
      <button onclick="showManagerTab('roster')" id="tab-roster" class="tab-button">üìÖ Roster</button>
      <button onclick="showManagerTab('leave')" id="tab-leave" class="tab-button">üìÑ Izin</button>
      <button onclick="showManagerTab('chat')" id="tab-chat" class="tab-button">üí¨ Chat</button>
    </div>
   </div>
   <div class="scrollable-content max-w-7xl mx-auto w-full">
    <!-- Stats -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
     <div class="bg-white rounded-2xl p-6 card-shadow border-l-4 border-blue-500"><div><p class="text-gray-600 text-xs">Total Karyawan</p><p id="stat-total-employees" class="text-2xl font-bold">0</p></div></div>
     <div class="bg-white rounded-2xl p-6 card-shadow border-l-4 border-green-500"><div><p class="text-gray-600 text-xs">Hadir Hari Ini</p><p id="stat-present-today" class="text-2xl font-bold">0</p></div></div>
     <div class="bg-white rounded-2xl p-6 card-shadow border-l-4 border-yellow-500"><div><p class="text-gray-600 text-xs">Pending Izin</p><p id="stat-pending-leaves" class="text-2xl font-bold">0</p></div></div>
    </div>
    
    <!-- TAB: Employees -->
    <div id="manager-tab-employees" class="tab-content">
     <div class="bg-white rounded-2xl p-8 card-shadow mb-8">
      <div class="flex justify-between items-center mb-6"><h2 class="text-2xl font-bold">üë• Karyawan</h2><button onclick="showEmployeeForm()" class="btn-primary text-white px-6 py-3 rounded-xl font-bold">‚ûï Tambah</button></div>
      <div id="employee-form" class="hidden mb-8 p-8 bg-purple-50 rounded-2xl">
       <form onsubmit="saveEmployee(event)" class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <input type="text" id="emp-id" readonly class="w-full p-3 border rounded-xl bg-gray-100">
        <input type="text" id="emp-name" required class="w-full p-3 border rounded-xl" placeholder="Nama">
        <select id="emp-position" required class="w-full p-3 border rounded-xl"><option>Barista</option><option>Kasir</option><option>Pelayan</option><option>Chef</option><option>Supervisor</option></select>
        <input type="tel" id="emp-phone" required class="w-full p-3 border rounded-xl" placeholder="Telepon">
        <input type="email" id="emp-email" required class="w-full p-3 border rounded-xl" placeholder="Email">
        <input type="text" id="emp-password" required placeholder="Password Login" class="w-full p-3 border rounded-xl">
        <div class="md:col-span-2 flex gap-4 mt-4"><button type="submit" id="btn-save-employee" class="flex-1 btn-success text-white font-bold py-3 rounded-xl">Simpan</button><button type="button" onclick="hideEmployeeForm()" class="flex-1 bg-gray-500 text-white font-bold py-3 rounded-xl">Batal</button></div>
       </form>
      </div>
      <div id="employee-list" class="space-y-4"></div>
     </div>
    </div>

    <!-- TAB: Attendance -->
    <div id="manager-tab-attendance" class="tab-content hidden"><div class="bg-white rounded-2xl p-8 card-shadow"><h2 class="text-2xl font-bold mb-6">üìä Absensi Hari Ini</h2><div id="today-attendance" class="space-y-4"></div></div></div>
    
    <!-- TAB: Roster (IMPROVED GRID) -->
    <div id="manager-tab-roster" class="tab-content hidden">
      <div class="bg-white rounded-2xl p-8 card-shadow">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold">üìÖ Jadwal Kerja (Tap to Change)</h2>
            <div class="flex gap-2 items-center bg-gray-100 p-1 rounded-lg">
                <button onclick="changeRosterWeek(-1)" class="px-3 py-1 bg-white rounded shadow text-sm font-bold">&lt;</button>
                <span id="roster-period-label" class="px-3 text-sm font-bold">Minggu Ini</span>
                <button onclick="changeRosterWeek(1)" class="px-3 py-1 bg-white rounded shadow text-sm font-bold">&gt;</button>
            </div>
        </div>
        <div class="overflow-x-auto">
            <table class="roster-table w-full text-sm">
                <thead>
                    <tr class="bg-gray-100" id="roster-header-row">
                        <th class="p-4">Karyawan</th>
                        <!-- Dates inserted here by JS -->
                    </tr>
                </thead>
                <tbody id="roster-grid-body">
                    <!-- Rows inserted here by JS -->
                </tbody>
            </table>
        </div>
        <div class="mt-4 flex gap-4 text-xs justify-center">
            <span class="flex items-center gap-1"><span class="w-3 h-3 rounded-full bg-yellow-200 border border-yellow-500"></span> Pagi</span>
            <span class="flex items-center gap-1"><span class="w-3 h-3 rounded-full bg-orange-200 border border-orange-500"></span> Siang</span>
            <span class="flex items-center gap-1"><span class="w-3 h-3 rounded-full bg-blue-200 border border-blue-500"></span> Malam</span>
            <span class="flex items-center gap-1"><span class="w-3 h-3 rounded-full bg-gray-200 border border-gray-400"></span> Off</span>
        </div>
      </div>
    </div>

    <!-- TAB: Leave -->
    <div id="manager-tab-leave" class="tab-content hidden"><div class="bg-white rounded-2xl p-8 card-shadow"><h2 class="text-2xl font-bold mb-6">üìÑ Izin Masuk</h2><div id="manager-leave-list" class="space-y-4"></div></div></div>
    
    <!-- TAB: Chat -->
    <div id="manager-tab-chat" class="tab-content hidden">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div class="bg-white rounded-2xl p-6 card-shadow"><h3 class="font-bold mb-4">Karyawan</h3><div id="manager-chat-employee-list" class="space-y-2"></div></div>
        <div id="manager-chat-room" class="md:col-span-2 bg-white rounded-2xl p-6 card-shadow flex flex-col h-[500px] hidden">
           <div class="border-b pb-2 mb-4 font-bold text-xl" id="manager-chat-title">Chat</div>
           <div id="manager-chat-messages" class="flex-1 overflow-y-auto space-y-3 mb-4 p-4 bg-gray-50 rounded-xl"></div>
           <form onsubmit="sendManagerMessage(event)" class="flex gap-2"><input id="manager-chat-input" class="flex-1 border p-3 rounded-xl" placeholder="Ketik..."><button class="btn-primary text-white px-6 rounded-xl">Kirim</button></form>
        </div>
        <div id="manager-chat-placeholder" class="md:col-span-2 bg-white rounded-2xl p-12 card-shadow flex items-center justify-center text-gray-400">Pilih karyawan</div>
      </div>
    </div>
   </div>
  </div>

  <!-- EMPLOYEE DASHBOARD -->
  <div id="employee-dashboard" class="hidden page-container">
   <header class="gradient-success text-white shadow-lg p-6">
    <div class="max-w-7xl mx-auto flex justify-between items-center">
     <div><h1 class="text-3xl font-bold mb-1">Halo, <span id="emp-dash-name">User</span></h1><p class="text-green-100">PayBoss Employee</p></div>
     <button onclick="logout()" class="px-6 py-2 bg-white bg-opacity-20 rounded-lg font-bold">Logout</button>
    </div>
   </header>
   <div class="bg-white shadow-md p-4">
    <div class="max-w-7xl mx-auto flex gap-4 flex-wrap">
      <button onclick="showEmployeeTab('attendance')" id="emp-tab-attendance" class="tab-button active">Absensi</button>
      <button onclick="showEmployeeTab('roster')" id="emp-tab-roster" class="tab-button">Jadwal</button>
      <button onclick="showEmployeeTab('leave')" id="emp-tab-leave" class="tab-button">Izin</button>
      <button onclick="showEmployeeTab('chat')" id="emp-tab-chat" class="tab-button">Chat</button>
    </div>
   </div>
   <div class="scrollable-content max-w-7xl mx-auto w-full">
    <div id="employee-content">
     <!-- TAB: Attendance -->
     <div id="employee-tab-attendance" class="tab-content">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
       <div id="clock-in-card" class="bg-white rounded-2xl p-8 card-shadow text-center"><div class="text-6xl mb-4">üü¢</div><h3 class="text-2xl font-bold mb-2">Clock In</h3><button onclick="showClockInModal()" class="w-full btn-success text-white font-bold py-4 rounded-xl text-lg">CLOCK IN</button></div>
       <div id="clock-out-card" class="bg-white rounded-2xl p-8 card-shadow text-center opacity-50 pointer-events-none"><div class="text-6xl mb-4">üî¥</div><h3 class="text-2xl font-bold mb-2">Clock Out</h3><button onclick="showClockOutModal()" class="w-full btn-danger text-white font-bold py-4 rounded-xl text-lg">CLOCK OUT</button></div>
      </div>
      <div class="bg-white rounded-2xl p-8 card-shadow"><h3 class="text-2xl font-bold mb-6">Riwayat</h3><div id="employee-attendance-list" class="space-y-4"></div></div>
     </div>
     <!-- TAB: Roster -->
     <div id="employee-tab-roster" class="tab-content hidden"><div class="bg-white rounded-2xl p-8 card-shadow"><h3 class="font-bold mb-4 text-xl">Jadwal Saya</h3><div id="employee-roster-list" class="grid grid-cols-1 md:grid-cols-3 gap-4"></div></div></div>
     <!-- TAB: Leave -->
     <div id="employee-tab-leave" class="tab-content hidden">
        <div class="bg-white rounded-2xl p-8 card-shadow mb-8">
            <h3 class="text-xl font-bold mb-4">Ajukan Izin</h3>
            <form onsubmit="submitLeaveRequest(event)" class="space-y-4">
                <select id="leave-type" class="w-full p-3 border rounded-xl"><option>Sakit</option><option>Izin</option><option>Cuti</option></select>
                <div class="flex gap-2"><input type="date" id="leave-start-date" class="w-full p-3 border rounded-xl"><input type="date" id="leave-end-date" class="w-full p-3 border rounded-xl"></div>
                <textarea id="leave-reason" class="w-full p-3 border rounded-xl" placeholder="Alasan"></textarea>
                <button type="submit" id="btn-submit-leave" class="w-full btn-success text-white font-bold py-3 rounded-xl">Kirim</button>
            </form>
        </div>
        <div id="employee-leave-list" class="space-y-4"></div>
     </div>
     <!-- TAB: Chat -->
     <div id="employee-tab-chat" class="tab-content hidden">
        <div class="bg-white rounded-2xl p-6 card-shadow h-[600px] flex flex-col">
            <div class="border-b pb-2 mb-4 font-bold text-xl">Chat dengan Manager</div>
            <div id="employee-chat-messages" class="flex-1 overflow-y-auto space-y-3 mb-4 p-4 bg-gray-50 rounded-xl"></div>
            <form onsubmit="sendEmployeeMessage(event)" class="flex gap-2"><input id="employee-chat-input" class="flex-1 border p-3 rounded-xl outline-none focus:border-green-500" placeholder="Ketik pesan..."><button class="btn-success text-white px-6 rounded-xl font-bold">Kirim</button></form>
        </div>
     </div>
    </div>
   </div>
  </div>

  <!-- MODALS -->
  <div id="clock-in-modal" class="modal-overlay hidden">
   <div class="modal-content">
    <h2 class="text-3xl font-bold text-center mb-4">‚úÖ Clock In</h2>
    <div class="space-y-4">
     <div class="bg-green-50 p-4 rounded-xl"><h3 class="font-bold mb-2">üì∏ Selfie</h3><div class="camera-view mb-2"><video id="video-in" autoplay playsinline></video><canvas id="canvas-in" class="hidden"></canvas><img id="photo-in" class="captured-photo"></div><div class="flex gap-2"><button onclick="initCamera('in')" class="flex-1 bg-blue-600 text-white py-2 rounded">Buka Kamera</button><button onclick="takeSnapshot('in')" class="flex-1 bg-green-600 text-white py-2 rounded">Ambil Foto</button></div><input type="hidden" id="selfie-in-data"></div>
     <div class="bg-blue-50 p-4 rounded-xl"><h3 class="font-bold mb-2">üìç GPS</h3><div id="gps-status-in" class="hidden mb-2 p-2 text-center font-bold rounded"></div><button onclick="getLocation('in')" class="w-full bg-blue-600 text-white py-2 rounded">Cek Lokasi</button><input type="text" id="location-in" readonly class="w-full mt-2 p-2 border rounded"></div>
     <div class="bg-yellow-50 p-4 rounded-xl"><h3 class="font-bold mb-2">üìù Job Desk</h3><div id="job-desk-start" class="space-y-2"></div></div>
     <textarea id="notes-in" class="w-full p-3 border rounded" placeholder="Catatan..."></textarea>
     <div class="flex gap-2"><button onclick="clockIn(event)" id="btn-submit-clock-in" disabled class="flex-1 bg-gray-400 text-white py-3 rounded font-bold cursor-not-allowed">SUBMIT</button><button onclick="hideClockInModal()" class="flex-1 bg-gray-200 py-3 rounded font-bold">Batal</button></div>
    </div>
   </div>
  </div>

  <div id="clock-out-modal" class="modal-overlay hidden">
   <div class="modal-content">
    <h2 class="text-3xl font-bold text-center mb-4">‚õî Clock Out</h2>
    <div class="space-y-4">
     <div class="bg-red-50 p-4 rounded-xl"><h3 class="font-bold mb-2">üì∏ Selfie</h3><div class="camera-view mb-2"><video id="video-out" autoplay playsinline></video><canvas id="canvas-out" class="hidden"></canvas><img id="photo-out" class="captured-photo"></div><div class="flex gap-2"><button onclick="initCamera('out')" class="flex-1 bg-blue-600 text-white py-2 rounded">Buka Kamera</button><button onclick="takeSnapshot('out')" class="flex-1 bg-green-600 text-white py-2 rounded">Ambil Foto</button></div><input type="hidden" id="selfie-out-data"></div>
     <div class="bg-blue-50 p-4 rounded-xl"><h3 class="font-bold mb-2">üìç GPS</h3><div id="gps-status-out" class="hidden mb-2 p-2 text-center font-bold rounded"></div><button onclick="getLocation('out')" class="w-full bg-blue-600 text-white py-2 rounded">Cek Lokasi</button><input type="text" id="location-out" readonly class="w-full mt-2 p-2 border rounded"></div>
     <div class="bg-yellow-50 p-4 rounded-xl"><h3 class="font-bold mb-2">üìã Job Desk Akhir</h3><div id="job-desk-end" class="space-y-2"></div></div>
     <textarea id="notes-out" class="w-full p-3 border rounded" placeholder="Catatan..."></textarea>
     <div class="flex gap-2"><button onclick="clockOut(event)" id="btn-submit-clock-out" disabled class="flex-1 bg-gray-400 text-white py-3 rounded font-bold cursor-not-allowed">SUBMIT</button><button onclick="hideClockOutModal()" class="flex-1 bg-gray-200 py-3 rounded font-bold">Batal</button></div>
    </div>
   </div>
  </div>

  <script>
    // --- CONFIGURATION ---
    // GANTI URL INI DENGAN HASIL DEPLOY BARU
    const API_URL = "https://script.google.com/macros/s/AKfycby49EpPVo7oHgFLLjS421nnYdKt7EjGa6elDQ4jKfnXa_9xQdtr2ysXbuwDB_j7G2cQ/exec";
    
    const TARGET_LAT = -2.1717597105563065;
    const TARGET_LON = 115.40300588753108;
    const MAX_RADIUS_METERS = 200;

    // ROSTER VARS
    let currentRosterWeekOffset = 0;
    const SHIFT_TYPES = ['Off', 'Pagi', 'Siang', 'Malam'];
    const SHIFT_STYLES = { 'Off': 'shift-off', 'Pagi': 'shift-pagi', 'Siang': 'shift-siang', 'Malam': 'shift-malam' };
    const SHIFT_TIMES = { 'Pagi': '06:00-14:00', 'Siang': '14:00-22:00', 'Malam': '22:00-06:00', 'Off': '-' };

    let allData = [], currentUser = null, currentChatEmployee = null;
    let currentJobDeskInCompleted = [], currentJobDeskOutCompleted = [];
    let mediaStream = null;

    const JOB_DESKS = {
      'Barista': { start: ['Cek mesin kopi', 'Stok susu', 'Bersihkan bar'], end: ['Matikan mesin', 'Bersihkan alat', 'Buang sampah'] },
      'Kasir': { start: ['Hitung modal', 'Cek struk', 'Nyalakan POS'], end: ['Hitung omzet', 'Setor uang', 'Matikan POS'] },
      'Pelayan': { start: ['Cek meja', 'Siapkan alat makan', 'Cek tisu'], end: ['Bersihkan meja', 'Sapu lantai', 'Matikan lampu'] },
      'Chef': { start: ['Cek bahan', 'Nyalakan kompor', 'Cek stok'], end: ['Bersihkan dapur', 'Simpan bahan', 'Matikan gas'] },
      'Supervisor': { start: ['Briefing tim', 'Cek area', 'Cek target'], end: ['Laporan harian', 'Evaluasi shift', 'Kunci pintu'] }
    };

    // --- API HELPER ---
    async function postData(action, payload = {}) {
      try {
        const body = JSON.stringify({ action, ...payload });
        const res = await fetch(API_URL, { method: 'POST', body: body });
        const data = await res.json();
        return data;
      } catch (e) {
        console.error(e);
        return { isOk: false, message: "Koneksi Error" };
      }
    }

    // --- INIT ---
    async function initApp() {
      updateDateTime();
      setInterval(updateDateTime, 1000);
      const res = await postData('getAll');
      if(res.isOk) allData = res.data;
    }

    function updateDateTime() {
      const now = new Date();
      const time = now.toLocaleTimeString('id-ID', {hour:'2-digit', minute:'2-digit'});
      const date = now.toLocaleDateString('id-ID', {weekday:'long', day:'numeric', month:'long'});
      if(document.getElementById('current-time')) document.getElementById('current-time').innerText = time;
      if(document.getElementById('current-date-manager')) document.getElementById('current-date-manager').innerText = date;
      if(document.getElementById('current-date-employee')) document.getElementById('current-date-employee').innerText = date;
    }

    function showToast(msg, type='success') {
      const t = document.createElement('div');
      t.className = `toast ${type}`; t.innerText = msg;
      document.body.appendChild(t);
      setTimeout(()=>t.remove(), 3000);
    }

    // --- LOGIN ---
    async function handleLogin(e) {
      e.preventDefault();
      const u = document.getElementById('login-username').value;
      const p = document.getElementById('login-password').value;
      const btn = document.getElementById('btn-login');
      btn.innerText = "Memproses..."; btn.disabled = true;
      const res = await postData('login', { username: u, password: p });
      
      if (res.isOk) {
        currentUser = res.user;
        document.getElementById('login-screen').classList.add('hidden');
        await initApp(); 
        if (res.role === 'manager') {
           document.getElementById('manager-dashboard').classList.remove('hidden');
           updateManagerDashboard();
        } else {
           document.getElementById('employee-dashboard').classList.remove('hidden');
           document.getElementById('emp-dash-name').innerText = currentUser.name;
           updateEmployeeDashboard();
        }
        showToast("Login Berhasil!");
      } else {
        showToast(res.message, "error");
      }
      btn.innerText = "üöÄ LOGIN MASUK"; btn.disabled = false;
    }

    function logout() { location.reload(); }

    // --- MANAGER ---
    function showManagerTab(tab) {
      ['employees','attendance','roster','leave','chat'].forEach(t => {
        document.getElementById('manager-tab-'+t).classList.add('hidden');
        document.getElementById('tab-'+t).classList.remove('active');
      });
      document.getElementById('manager-tab-'+tab).classList.remove('hidden');
      document.getElementById('tab-'+tab).classList.add('active');
      if(tab === 'chat') renderManagerChatEmployeeList();
      if(tab === 'roster') renderRosterGrid();
    }

    function updateManagerDashboard() {
      renderEmployeeList();
      renderTodayAttendance();
      renderManagerLeaveList();
      // Stats
      const emps = allData.filter(d=>d.type==='employee');
      const atts = allData.filter(d=>d.type==='attendance' && d.attendance_date === new Date().toISOString().split('T')[0]);
      document.getElementById('stat-total-employees').innerText = emps.length;
      document.getElementById('stat-present-today').innerText = atts.length;
    }

    // Employee CRUD
    function showEmployeeForm() { document.getElementById('employee-form').classList.remove('hidden'); document.getElementById('emp-id').value = 'EMP'+Date.now().toString().slice(-4); }
    function hideEmployeeForm() { document.getElementById('employee-form').classList.add('hidden'); }

    async function saveEmployee(e) {
      e.preventDefault();
      const btn = document.getElementById('btn-save-employee');
      btn.innerText = "Menyimpan..."; btn.disabled = true;
      const payload = {
        type: 'employee',
        employee_id: document.getElementById('emp-id').value,
        name: document.getElementById('emp-name').value,
        position: document.getElementById('emp-position').value,
        phone: document.getElementById('emp-phone').value,
        email: document.getElementById('emp-email').value,
        password: document.getElementById('emp-password').value
      };
      await postData('create', { payload });
      hideEmployeeForm();
      btn.innerText = "Simpan"; btn.disabled = false;
      showToast("Karyawan disimpan");
      await initApp(); updateManagerDashboard();
    }

    function renderEmployeeList() {
      const list = document.getElementById('employee-list');
      const emps = allData.filter(d=>d.type==='employee');
      list.innerHTML = emps.map(e => `
        <div class="bg-purple-50 p-4 rounded-xl border mb-2 flex justify-between items-center">
          <div><h4 class="font-bold">${e.name}</h4><p class="text-sm text-gray-600">${e.position} | ${e.employee_id}</p></div>
          <button onclick="deleteItem('${e.employee_id}', 'employee')" class="text-red-600 font-bold text-sm">Hapus</button>
        </div>
      `).join('');
    }

    async function deleteItem(id, type) {
      if(!confirm("Hapus data ini?")) return;
      await postData('delete', { payload: { type, employee_id: id } });
      await initApp(); updateManagerDashboard();
    }

    function renderTodayAttendance() {
      const list = document.getElementById('today-attendance');
      const today = new Date().toISOString().split('T')[0];
      const atts = allData.filter(d => d.type==='attendance' && d.attendance_date === today);
      if(atts.length===0) list.innerHTML = '<p class="text-center text-gray-400 py-4">Belum ada absensi</p>';
      else list.innerHTML = atts.map(a => `
        <div class="bg-green-50 p-4 rounded-xl border mb-2">
          <div class="flex justify-between font-bold"><span>${a.name}</span><span class="text-xs bg-white px-2 rounded">${a.attendance_status}</span></div>
          <div class="text-sm mt-1">In: ${a.clock_in_time} | Out: ${a.clock_out_time || '-'}</div>
        </div>
      `).join('');
    }

    function renderManagerLeaveList() {
      const list = document.getElementById('manager-leave-list');
      const leaves = allData.filter(d=>d.type==='leave');
      list.innerHTML = leaves.map(l => `
        <div class="bg-white p-4 border rounded-xl mb-2">
          <div class="flex justify-between font-bold"><span>${l.name}</span><span class="text-${l.status==='Pending'?'yellow':'green'}-600">${l.status}</span></div>
          <p class="text-sm">${l.leave_type}: ${l.start_date}</p>
          <p class="text-xs text-gray-500 mb-2">${l.reason}</p>
          ${l.status === 'Pending' ? `
            <div class="flex gap-2">
              <button onclick="approveLeave('${l.employee_id}', '${l.start_date}', 'Disetujui')" class="bg-green-500 text-white px-3 py-1 rounded text-xs">Terima</button>
              <button onclick="approveLeave('${l.employee_id}', '${l.start_date}', 'Ditolak')" class="bg-red-500 text-white px-3 py-1 rounded text-xs">Tolak</button>
            </div>
          ` : ''}
        </div>
      `).join('');
    }

    async function approveLeave(id, date, status) {
      const payload = { type: 'leave', employee_id: id, start_date: date, status: status, approved_by: 'Manager', approved_at: new Date().toISOString() };
      await postData('update', { payload });
      await initApp(); updateManagerDashboard();
    }

    // --- NEW ROSTER GRID LOGIC ---
    function changeRosterWeek(offset) {
      currentRosterWeekOffset += offset;
      renderRosterGrid();
    }

    function renderRosterGrid() {
      const headerRow = document.getElementById('roster-header-row');
      const body = document.getElementById('roster-grid-body');
      const emps = allData.filter(d => d.type === 'employee');
      const rosters = allData.filter(d => d.type === 'roster');

      // Calculate Dates for the week
      const today = new Date();
      const dayOfWeek = today.getDay(); // 0-6
      const startDiff = today.getDate() - dayOfWeek + (dayOfWeek == 0 ? -6 : 1) + (currentRosterWeekOffset * 7);
      
      const weekDates = [];
      // Rebuild Header
      headerRow.innerHTML = '<th class="p-4">Karyawan</th>';
      
      for (let i=0; i<7; i++) {
        const d = new Date(today);
        d.setDate(startDiff + i);
        const dateStr = d.toLocaleDateString('id-ID', {weekday:'short', day:'numeric'});
        const isoDate = d.toISOString().split('T')[0];
        weekDates.push({ display: dateStr, iso: isoDate });
        headerRow.innerHTML += `<th class="p-2 text-xs">${dateStr}</th>`;
      }

      // Build Rows
      body.innerHTML = emps.map(e => {
        let cells = `<td class="p-2 font-bold text-xs text-gray-700">${e.name}</td>`;
        
        weekDates.forEach(dt => {
          const shift = rosters.find(r => r.employee_id === e.employee_id && r.roster_date === dt.iso);
          const shiftType = shift ? shift.shift_type : 'Off';
          const style = SHIFT_STYLES[shiftType];
          
          cells += `<td onclick="cycleShift('${e.employee_id}', '${e.name}', '${dt.iso}', '${shiftType}')">
            <div class="roster-cell ${style}">
              ${shiftType === 'Off' ? '‚ùå' : shiftType}
            </div>
          </td>`;
        });
        return `<tr>${cells}</tr>`;
      }).join('');
      
      const startLabel = weekDates[0].display;
      const endLabel = weekDates[6].display;
      document.getElementById('roster-period-label').innerText = `${startLabel} - ${endLabel}`;
    }

    async function cycleShift(empId, empName, date, currentType) {
      // Logic: Off -> Pagi -> Siang -> Malam -> Off
      const currentIndex = SHIFT_TYPES.indexOf(currentType);
      const nextIndex = (currentIndex + 1) % SHIFT_TYPES.length;
      const nextType = SHIFT_TYPES[nextIndex];
      const nextTime = SHIFT_TIMES[nextType];
      
      const payload = {
        type: 'roster',
        employee_id: empId,
        name: empName,
        roster_date: date,
        shift_type: nextType,
        shift_start: nextTime.split('-')[0] || '',
        shift_end: nextTime.split('-')[1] || ''
      };
      
      // Optimistic Update (Update UI immediately)
      // Note: For simplicity, we just call API and reload grid. 
      // To make it faster, we could update DOM directly then sync.
      // Let's stick to standard flow for reliability.
      
      // Show small saving indicator or just wait? 
      // Let's reload.
      await postData('create', { payload });
      
      // Refresh local data manually to avoid full fetch lag
      // Remove old entry
      allData = allData.filter(d => !(d.type === 'roster' && d.employee_id === empId && d.roster_date === date));
      // Add new entry
      allData.push({ type: 'roster', employee_id: empId, name: empName, roster_date: date, shift_type: nextType, shift_start: payload.shift_start, shift_end: payload.shift_end });
      
      renderRosterGrid();
    }

    // --- MANAGER CHAT ---
    function renderManagerChatEmployeeList() {
      const emps = allData.filter(d=>d.type==='employee');
      document.getElementById('manager-chat-employee-list').innerHTML = emps.map(e => `
        <div onclick="openManagerChat('${e.employee_id}', '${e.name}')" class="p-3 border rounded-xl cursor-pointer hover:bg-purple-50 transition">
           <p class="font-bold">${e.name}</p><p class="text-xs text-gray-500">${e.position}</p>
        </div>
      `).join('');
    }

    function openManagerChat(id, name) {
      currentChatEmployee = { id, name };
      document.getElementById('manager-chat-placeholder').classList.add('hidden');
      document.getElementById('manager-chat-room').classList.remove('hidden');
      document.getElementById('manager-chat-title').innerText = name;
      renderManagerChatMessages();
    }

    function renderManagerChatMessages() {
      if(!currentChatEmployee) return;
      const msgs = allData.filter(d => d.type==='chat' && ((d.sender_id==='manager' && d.receiver_id===currentChatEmployee.id) || (d.sender_id===currentChatEmployee.id && d.receiver_id==='manager')));
      msgs.sort((a,b) => new Date(a.timestamp) - new Date(b.timestamp));
      
      const container = document.getElementById('manager-chat-messages');
      container.innerHTML = msgs.map(m => `
        <div class="flex ${m.sender_id==='manager'?'justify-end':'justify-start'}">
          <div class="${m.sender_id==='manager'?'bg-purple-600 text-white':'bg-gray-200 text-gray-800'} px-4 py-2 rounded-xl text-sm max-w-xs">
            ${m.message}
          </div>
        </div>
      `).join('');
      container.scrollTop = container.scrollHeight;
    }

    async function sendManagerMessage(e) {
      e.preventDefault();
      const input = document.getElementById('manager-chat-input');
      const payload = {
        type: 'chat',
        sender_id: 'manager', sender_name: 'Manager',
        receiver_id: currentChatEmployee.id, receiver_name: currentChatEmployee.name,
        message: input.value, timestamp: new Date().toISOString(), is_read: false
      };
      await postData('create', { payload });
      input.value = '';
      await initApp(); renderManagerChatMessages();
    }

    // --- EMPLOYEE LOGIC ---
    function showEmployeeTab(tab) {
      ['attendance','roster','leave','chat'].forEach(t => {
        document.getElementById('employee-tab-'+t).classList.add('hidden');
        document.getElementById('emp-tab-'+t).classList.remove('active');
      });
      document.getElementById('employee-tab-'+tab).classList.remove('hidden');
      document.getElementById('emp-tab-'+tab).classList.add('active');
      
      if(tab==='roster') renderEmployeeRoster();
      if(tab==='leave') renderEmployeeLeaveList();
      if(tab==='chat') renderEmployeeChatMessages();
    }

    function updateEmployeeDashboard() {
      const myAtt = allData.filter(d => d.type === 'attendance' && d.employee_id === currentUser.employee_id);
      const today = new Date().toISOString().split('T')[0];
      const att = myAtt.find(a => a.attendance_date === today);
      
      const inCard = document.getElementById('clock-in-card');
      const outCard = document.getElementById('clock-out-card');
      
      if(att) {
         if(att.clock_out_time) { // Selesai
            inCard.classList.add('opacity-50','pointer-events-none');
            outCard.classList.add('opacity-50','pointer-events-none');
         } else { // Sudah masuk, belum pulang
            inCard.classList.add('opacity-50','pointer-events-none');
            outCard.classList.remove('opacity-50','pointer-events-none');
         }
      } else { // Belum masuk
         inCard.classList.remove('opacity-50','pointer-events-none');
         outCard.classList.add('opacity-50','pointer-events-none');
      }
      
      // Render History
      document.getElementById('employee-attendance-list').innerHTML = myAtt.map(a => `
        <div class="bg-white p-4 border rounded-xl mb-2 shadow-sm">
           <div class="flex justify-between font-bold"><span>${a.attendance_date}</span><span>${a.attendance_status}</span></div>
           <div class="text-sm mt-1">In: ${a.clock_in_time} | Out: ${a.clock_out_time || '-'}</div>
        </div>
      `).join('');
    }

    function renderEmployeeRoster() {
      const rosters = allData.filter(d => d.type === 'roster' && d.employee_id === currentUser.employee_id);
      document.getElementById('employee-roster-list').innerHTML = rosters.map(r => `
        <div class="bg-purple-50 p-4 rounded-xl text-center border border-purple-100">
           <div class="font-bold text-lg">${r.roster_date}</div>
           <div class="text-purple-600 font-bold">${r.shift_type}</div>
        </div>
      `).join('');
    }

    async function submitLeaveRequest(e) {
      e.preventDefault();
      const btn = document.getElementById('btn-submit-leave');
      btn.disabled = true; btn.innerText = "Mengirim...";
      
      const payload = {
        type: 'leave',
        employee_id: currentUser.employee_id,
        name: currentUser.name,
        position: currentUser.position,
        leave_type: document.getElementById('leave-type').value,
        start_date: document.getElementById('leave-start-date').value,
        end_date: document.getElementById('leave-end-date').value,
        reason: document.getElementById('leave-reason').value,
        status: 'Pending'
      };
      
      await postData('create', { payload });
      showToast("Izin diajukan");
      btn.disabled = false; btn.innerText = "Kirim Pengajuan";
      await initApp(); renderEmployeeLeaveList();
    }

    function renderEmployeeLeaveList() {
      const leaves = allData.filter(d => d.type === 'leave' && d.employee_id === currentUser.employee_id);
      document.getElementById('employee-leave-list').innerHTML = leaves.map(l => `
        <div class="bg-white p-4 border rounded-xl mb-2">
           <p class="font-bold">${l.leave_type} <span class="text-gray-500 text-xs">(${l.status})</span></p>
           <p class="text-xs">${l.start_date} s/d ${l.end_date}</p>
        </div>
      `).join('');
    }

    function renderEmployeeChatMessages() {
      const msgs = allData.filter(d => d.type==='chat' && ((d.sender_id===currentUser.employee_id && d.receiver_id==='manager') || (d.sender_id==='manager' && d.receiver_id===currentUser.employee_id)));
      msgs.sort((a,b) => new Date(a.timestamp) - new Date(b.timestamp));
      
      const container = document.getElementById('employee-chat-messages');
      container.innerHTML = msgs.map(m => `
        <div class="flex ${m.sender_id===currentUser.employee_id?'justify-end':'justify-start'}">
          <div class="${m.sender_id===currentUser.employee_id?'bg-green-600 text-white':'bg-gray-200 text-gray-800'} px-4 py-2 rounded-xl text-sm max-w-xs">
            ${m.message}
          </div>
        </div>
      `).join('');
      container.scrollTop = container.scrollHeight;
    }

    async function sendEmployeeMessage(e) {
      e.preventDefault();
      const input = document.getElementById('employee-chat-input');
      const payload = {
        type: 'chat',
        sender_id: currentUser.employee_id, sender_name: currentUser.name,
        receiver_id: 'manager', receiver_name: 'Manager',
        message: input.value, timestamp: new Date().toISOString(), is_read: false
      };
      await postData('create', { payload });
      input.value = '';
      await initApp(); renderEmployeeChatMessages();
    }

    // --- CLOCK IN/OUT (FIXED with postData) ---
    function showClockInModal() { 
        document.getElementById('clock-in-modal').classList.remove('hidden'); 
        initCamera('in');
        const list = JOB_DESKS[currentUser.position]?.start || [];
        document.getElementById('job-desk-start').innerHTML = list.map((t, i) => `<label class="flex gap-2 p-2 border rounded"><input type="checkbox" onchange="updateJobIn(${i},this.checked)"> ${t}</label>`).join('');
        currentJobDeskInCompleted = [];
    }
    function showClockOutModal() { 
        document.getElementById('clock-out-modal').classList.remove('hidden'); 
        initCamera('out'); 
        const list = JOB_DESKS[currentUser.position]?.end || [];
        document.getElementById('job-desk-end').innerHTML = list.map((t, i) => `<label class="flex gap-2 p-2 border rounded"><input type="checkbox" onchange="updateJobOut(${i},this.checked)"> ${t}</label>`).join('');
        currentJobDeskOutCompleted = [];
    }
    function hideClockInModal() { document.getElementById('clock-in-modal').classList.add('hidden'); stopCamera(); }
    function hideClockOutModal() { document.getElementById('clock-out-modal').classList.add('hidden'); stopCamera(); }

    function updateJobIn(i, c) { c ? currentJobDeskInCompleted.push(i) : currentJobDeskInCompleted.splice(currentJobDeskInCompleted.indexOf(i), 1); }
    function updateJobOut(i, c) { c ? currentJobDeskOutCompleted.push(i) : currentJobDeskOutCompleted.splice(currentJobDeskOutCompleted.indexOf(i), 1); }

    async function clockIn(e) {
      e.preventDefault();
      const btn = document.getElementById('btn-submit-clock-in');
      btn.disabled = true; btn.innerText = "Memproses...";
      
      const payload = {
        type: 'attendance',
        employee_id: currentUser.employee_id, name: currentUser.name, position: currentUser.position,
        attendance_date: new Date().toISOString().split('T')[0],
        clock_in_time: new Date().toLocaleTimeString('id-ID', {hour:'2-digit', minute:'2-digit'}),
        attendance_status: new Date().getHours() >= 9 ? 'Terlambat' : 'Tepat Waktu',
        location_in: document.getElementById('location-in').value,
        selfie_in_url: document.getElementById('selfie-in-data').value,
        notes_in: document.getElementById('notes-in').value,
        job_desk_in: currentJobDeskInCompleted.length + ' tugas selesai'
      };
      
      await postData('create', { payload });
      hideClockInModal();
      await initApp(); updateEmployeeDashboard();
      showToast("Berhasil Clock In");
    }

    async function clockOut(e) {
      e.preventDefault();
      const btn = document.getElementById('btn-submit-clock-out');
      btn.disabled = true; btn.innerText = "Memproses...";
      
      const payload = {
        type: 'attendance',
        employee_id: currentUser.employee_id,
        attendance_date: new Date().toISOString().split('T')[0],
        clock_out_time: new Date().toLocaleTimeString('id-ID', {hour:'2-digit', minute:'2-digit'}),
        location_out: document.getElementById('location-out').value,
        selfie_out_url: document.getElementById('selfie-out-data').value,
        notes_out: document.getElementById('notes-out').value,
        job_desk_out: currentJobDeskOutCompleted.length + ' tugas selesai'
      };
      
      await postData('update', { payload });
      hideClockOutModal();
      await initApp(); updateEmployeeDashboard();
      showToast("Berhasil Clock Out");
    }

    // CAMERA & GPS
    async function initCamera(type) {
        try {
            if(mediaStream) mediaStream.getTracks().forEach(t=>t.stop());
            mediaStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } });
            document.getElementById('video-'+type).srcObject = mediaStream;
            document.getElementById('video-'+type).classList.remove('hidden');
            document.getElementById('photo-'+type).classList.add('hidden');
        } catch(e){ showToast("Kamera Error","error"); }
    }
    function takeSnapshot(type) {
        const v = document.getElementById('video-'+type);
        const c = document.getElementById('canvas-'+type);
        c.width = v.videoWidth; c.height = v.videoHeight;
        c.getContext('2d').drawImage(v,0,0);
        const data = c.toDataURL('image/jpeg');
        document.getElementById('selfie-'+type+'-data').value = data;
        document.getElementById('photo-'+type).src = data;
        document.getElementById('photo-'+type).classList.remove('hidden');
        v.classList.add('hidden');
    }
    function stopCamera() { if(mediaStream) mediaStream.getTracks().forEach(t=>t.stop()); }

    function getLocation(type) {
        const status = document.getElementById('gps-status-'+type);
        const btn = document.getElementById('btn-submit-clock-'+type);
        status.classList.remove('hidden'); status.innerText = "Mendeteksi...";
        
        navigator.geolocation.getCurrentPosition(pos => {
            const dist = getDist(pos.coords.latitude, pos.coords.longitude, TARGET_LAT, TARGET_LON);
            document.getElementById('location-'+type).value = `${pos.coords.latitude},${pos.coords.longitude} (${Math.round(dist)}m)`;
            
            if (dist <= MAX_RADIUS_METERS) {
                status.innerText = "‚úÖ Lokasi Valid"; status.className = "mb-2 p-2 bg-green-100 text-green-800 rounded text-center font-bold";
                btn.disabled = false; btn.classList.remove('bg-gray-400', 'cursor-not-allowed');
                btn.classList.add(type==='in'?'bg-green-600':'bg-red-600');
                btn.innerText = "SUBMIT";
            } else {
                status.innerText = `‚ùå Diluar Radius (${Math.round(dist)}m)`; status.className = "mb-2 p-2 bg-red-100 text-red-800 rounded text-center font-bold";
                btn.disabled = true;
            }
        });
    }
    
    function getDist(lat1, lon1, lat2, lon2) {
        const R = 6371e3; 
        const œÜ1 = lat1 * Math.PI/180, œÜ2 = lat2 * Math.PI/180;
        const ŒîœÜ = (lat2-lat1) * Math.PI/180, ŒîŒª = (lon2-lon1) * Math.PI/180;
        const a = Math.sin(ŒîœÜ/2)**2 + Math.cos(œÜ1)*Math.cos(œÜ2) * Math.sin(ŒîŒª/2)**2;
        return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }

    document.addEventListener('DOMContentLoaded', initApp);
  </script>
 </body>
</html>
